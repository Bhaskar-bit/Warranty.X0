<!DOCTYPE html>
<html lang="en">
<head>
  <title>Warranty X.0</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://npmcdn.com/simple-statistics@2.0.0-beta3/dist/simple-statistics.min.js"></script>
  <script src="https://d3js.org/queue.v1.min.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <script src="./d3-tip.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js" type="text/javascript"></script>
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="Stylesheet" type="text/css" />
    <script src="./jQDateRangeSlider-min.js"></script>
   <style>
  .bar {
  fill: steelblue;
}
.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}
.country {
  fill: #b8b8b8;
  stroke: #fff;
  stroke-width: .5px;
  stroke-linejoin: round;
}

.graticule {
  fill: none;
  stroke: #000;
  stroke-opacity: .3;
  stroke-width: .5px;
}

.graticule-outline {
  fill: none;
  stroke: #333;
  stroke-width: 1.5px;
}.arc text {
  font: 10px sans-serif;
  text-anchor: middle;
}

.arc path {
  stroke: #fff;
}

.toolTip {
    position: absolute;
    display: none;
    width: auto;
    height: auto;
    background: none repeat scroll 0 0 white;
    border: 0 none;
    border-radius: 8px 8px 8px 8px;
    box-shadow: -3px 3px 15px #888888;
    color: black;
    font: 12px sans-serif;
    padding: 5px;
    text-align: center;
}
.bar {
            fill: #5f89ad;
        }
        .names {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
  }

    /* Tooltip CSS */
    .d3-tip {
    line-height: 1.5;
    font-weight: 400;
    font-family:"avenir next", Arial, sans-serif;
    padding: 6px;
    background: rgba(0, 0, 0, 0.6);
    color: #FFA500;
    border-radius: 1px;
    pointer-events: none;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {      
      box-sizing: border-box;
      display: inline;
      font-size: 8px;
      width: 100%;
      line-height: 1.5;
      color: rgba(0, 0, 0, 0.6);
      position: absolute;
      pointer-events: none;
      
    }

    /* Northward tooltips */
    .d3-tip.n:after {
      content: "\25BC";
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
      text-align: center;
    }

    /* Eastward tooltips */
    .d3-tip.e:after {
      content: "\25C0";
      margin: -4px 0 0 0;
      top: 50%;
      left: -8px;
    }

    /* Southward tooltips */
    .d3-tip.s:after {
      content: "\25B2";
      margin: 0 0 1px 0;
      top: -8px;
      left: 0;
      text-align: center;
    }

    /* Westward tooltips */
    .d3-tip.w:after {
      content: "\25B6";
      margin: -4px 0 0 -1px;
      top: 50%;
      left: 100%;
    }

/*    text{
      pointer-events:none;
    }*/

    .details{
      color:white;
    }
    .chart-container {
  /* width:50%; */
  height:40%;
  /* border: 1px dotted silver; */
}
#contentdiv{
zoom: 80%;

}
.wid{
  width: 100%;
}
applet, object, iframe,
h1, h2, h3, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed, 
figure, figcaption, footer, header, hgroup, 
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
	margin: 0;
	padding: 0;
	border: 0;
	font: inherit;
	font-size: 100%;
	vertical-align: baseline;
   font-family: "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
   font-weight: inherit;
}

h1 {
	font-size:150%;
   font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif; 
   font-weight: 300;
	text-align: left;
	margin-top: 5px;
	margin-bottom: 5px;
}
h2 {
	font-size: 12px;
	font-style: italic;
	color: gray;
	margin-top:5px;
	margin-bottom:5px;
}
h4{
color: white;

}
#everything{
	width:600px;
	margin:20px;
}
#chart{
	width:600px;
	height:400px;
}
.bar{
	fill:red;
}
text.label{
	fill: white;
	color:white;
	font-size: 20px;
	font-weight: bold;
}
text.category{
	fill: white;
	font-size: 14px;
}

  </style>
</head>
<body style="background-color: black ;overflow: hidden;">

<nav class="navbar bg-dark navbar-dark">
  <a class="navbar-brand" href="#">WARRANTY X.0</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="collapsibleNavbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="overview.html">Overview</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="dashboard.html">EI Journey</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#">Link</a>
      </li>    
    </ul>
  </div>  
</nav>
<br>
<!-- <div class="row" id="records_fetch" style="width:100%;padding-left:2% ;">
  <input id="fetchData"> <h4>click me</h4></input>


</div>
&nbsp; -->
<div id="contentdiv">
<div class="row"style="width:100%;padding-left:5% ;">
    <!-- <div class="column" id="dateFilter"  style="background-color:grey;height:2% ;max-width:20%" >
        <h4> Date Filter</h4> 
        <div >
          <select id="dateSlider">
              <option value="11/8/2019">11/8/2019</option>
              <option value="11/9/2019">11/9/2019</option>
              <option value="11/10/2019">11/10/2019</option>
              <option value="11/11/2019">11/11/2019</option>
              <option value="11/12/2019">11/12/2019</option>
          </select>
          <button id="play-button">Play</button>

        </div>
            </div>
     &nbsp; -->
    <div class="column" id="records_fetch" style="padding-left:2%;background-color:#505050;max-width:25%">
        <h4> Summary and Filter</h4> 
        <div  style="padding-left: 20%">
          <select id="dateSlider">
              <!-- <option value="11/8/2019">11/8/2019</option>
              <option value="11/9/2019">11/9/2019</option>
              <option value="11/10/2019">11/10/2019</option>
              <option value="11/11/2019">11/11/2019</option>
              <option value="11/12/2019">11/12/2019</option> -->
          </select>
          <button id="play-button">Play</button>
          <button id="pause-button">Pause</button>
          <button id="reset-button">Reset</button>
        </br>

        </div>
    
      </div>
      &nbsp;
      <div  class="column "  id="svgDonut"  style="background-color:#505050;height:2%;max-width: 35%">
       <h4>Module Distribution</h4>
        <!-- width="350" height="200" -->
    </div>
&nbsp;
        <div class="column" id="svgPie" style="background-color:#505050;height:2%;max-width:35%">
            <h4>DTC Status</h4> 
        </div>
&nbsp;

        <div class="column" id="chart"  style="background-color:#505050;height:2% ;max-width:30%" >
           <h4>EI Chart</h4> 
           <!-- <button id="start-button">Start</button>
           <button id="stop-button">stop</button> -->
        </div>
        
       
</div>
&nbsp;

<div class="row"style="width:100% ;padding-left:5%;">
            <div class="column" id="riskMeasure"  style="background-color: #505050; width:26%; " >
                <h4>Risk Pattern</h4>
            </div>
           &nbsp;
            <div class="column" id="svgworldChart" style="background-color: #505050;height:2%; width:40%" >
                <h4>Top Causal Part /Country</h4>
              
            </div>
            &nbsp;
            <div class="column" id="svgBar" style="background-color:#505050; width:26%" >
                <h4>Top 10 Causal Part (Failure/Time to fail)</h4>
              
            </div>
          
 </div>
 &nbsp;       
  <div class="row"style="width:100%;padding-left:5%;padding-bottom:15% ">
              
            <div  class="column "id="svgCausalPartBar"  style="background-color:#505050;height:2%;width:45%">
                <h4>Top Causal Parts</h4>
                <!-- width="350" height="200" -->
            </div>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <div class="column" id="topDtcgroup"  style="background-color:#505050;height:2%;width:45%">
                <h4>Top 5 DTC</h4>     
            </div>
            &nbsp;
           
        
   </div>
  

  </div>

</body>
</html>


<script>
  

  
 const url= 'http://localhost:3000/rows';
fetch(url)
  .then(function(response) {
    return response.json();
  })
  .then(function(myJson) {
    const url_1= 'http://localhost:3000/Ei_data';
fetch(url_1)
  .then(function(response) {
    return response.json();
  })
  .then(function(myEi) {
    var total_Dates= [];

    total_Dates= d3.nest()
   .key(function(d) { return d.session_date})
   //.rollup(function(v) { return v.length })
   .entries(myJson);


   total_Dates.sort(function(x, y){
     console.log(Date(x.key));
     return new Date(x.key) - new Date(y.key);
   //return d3.ascending(Date(x.key), Date(y.key));
});
    console.log(total_Dates);
    $(function() {
      total_Dates;
    $.each(total_Dates, function(i, option) {
        $('#dateSlider').append($('<option/>').attr("value", option.key).text(option.key));
    });
})


    var elem2 = document.createElement('label');
    elem2.style.paddingLeft='20%';
    elem2.innerHTML = "<span style='color: white;'>Total number of Signals :" +myJson.length+"</span>"; 
    document.getElementById("records_fetch").appendChild(elem2);
 
    var total_causalParts= [];
    var total_causalParts_datewise= [];
    document.getElementById("records_fetch").style.padding = "0px 10px 0px 0px";

    total_causalParts= d3.nest()
   .key(function(d) { return d.predict;})
   .rollup(function(v) { return v.length })
   .entries(myJson);
 
   var linebreak = document.createElement("br");
  
    var elem3 = document.createElement('label');
    elem3.style.paddingLeft='20%';
    elem3.innerHTML = "<span style='color: white;'>Total number of causal Parts :" +total_causalParts.length+"</span>"; 
    document.getElementById("records_fetch").appendChild(linebreak);
    document.getElementById("records_fetch").appendChild(elem3);

    
    var JsonByNameof_dtc =[]
    
    JsonByNameof_dtc= d3.nest()
  .key(function(d) { return d.dtc_status_conv; })
  .rollup(function(v) { return v.length })
  .entries(myJson);

  var JsonByNumberof_vins =[]
    
    JsonByNumberof_vins= d3.nest()
  .key(function(d) { return d.vin; })
  .rollup(function(v) { return v.length })
  .entries(myJson);


  
    var elem4 = document.createElement('label');
    elem4.style.paddingLeft='20%';
    elem4.innerHTML = "<span style='color: white;'>Total number of DTC :"  +JsonByNameof_dtc.length+"</span>"; 
    document.getElementById("records_fetch").appendChild(linebreak);
    document.getElementById("records_fetch").appendChild(elem4);


    var elem5 = document.createElement('label');
    elem5.style.paddingLeft='20%';
    elem5.innerHTML = "<span style='color: white;'>Total number of Vins :"  +JsonByNumberof_vins.length+"</span>"; 
    document.getElementById("records_fetch").appendChild(linebreak);
    document.getElementById("records_fetch").appendChild(elem5);
  //  setInterval(function(){ alert("Hello"); }, 3000);




  //  setInterval(function(){ alert("Hello"); }, 3000);
  function reset(){ 
    elem2.innerHTML ="<span style='color: white;'>Total number of Signals :" +myJson.length+"</span>"; 
  elem3.innerHTML = "<span style='color: white;'>Total number of causal Parts :" +total_causalParts.length+"</span>";
  elem4.innerHTML = "<span style='color: white;'>Total number of DTC :" +JsonByNameof_dtc.length+"</span>";
  elem5.innerHTML = "<span style='color: white;'>Total number of Vins :"  +JsonByNumberof_vins.length+"</span>";  
  CreateCharts(myJson);
  EI_Chart(myEi);
} 
var ref=null;
var isPaused=false;
var addedData=[];
  function longForLoop(limit) {
  var i = 0;
   ref = setInterval(() => {
    if(!isPaused) {
    var element = total_Dates[i];
 
 document.getElementById('dateSlider').value= element.key;
     // var addedData = [];
      var DatewiseData = myJson.filter(function(el) {
  var sessionD = el.session_date;
  return sessionD == element.key;
  });
console.log(DatewiseData)
//addedData.push(DatewiseData);
  //   if(i > 1){
   
 //console.log(addedData);
// }
  var DatewiseData_Ei = myEi.filter(function(el) {
  var sessionD = el.ei_date_time;
  return sessionD == element.key;
  });

  total_causalParts_datewise= d3.nest()
   .key(function(d) { return d.predict;})
   .rollup(function(v) { return v.length })
   .entries(DatewiseData);

   
   JsonByNameof_dtc= d3.nest()
  .key(function(d) { return d.dtc_status_conv; })
  .rollup(function(v) { return v.length })
  .entries(DatewiseData);
  elem2.innerHTML = "<span style='color: white;'>Total number of Signals :" +DatewiseData.length+"</span>"; 
  elem3.innerHTML = "<span style='color: white;'>Total number of causal Parts :" +total_causalParts_datewise.length+"</span>";
  elem4.innerHTML = "<span style='color: white;'>Total number of DTC :" +JsonByNameof_dtc.length+"</span>"; 
  elem5.innerHTML = "<span style='color: white;'>Total number of Vins :"  +JsonByNumberof_vins.length+"</span>"; 
  CreateCharts(DatewiseData,i)
  EI_Chart(DatewiseData_Ei,i) + ++i;
    if (i == limit) clearInterval(ref);
}
  }, 5000);
}

$("#pause-button").click( function (e) {
  e.preventDefault();
  isPaused=true;
    //clearInterval(ref);
});


    $("#play-button").click(function(e){

//console.log(total_Dates);
e.preventDefault();
isPaused = false;
longForLoop(total_Dates.length);
//reset();
});

$("#reset-button").click(function(){
  elem2.innerHTML ="<span style='color: white;'>Total number of Signals :" +myJson.length+"</span>"; 
  elem3.innerHTML = "<span style='color: white;'>Total number of causal Parts :" +total_causalParts.length+"</span>";
  elem4.innerHTML = "<span style='color: white;'>Total number of DTC :" +JsonByNameof_dtc.length+"</span>"; 
  elem5.innerHTML = "<span style='color: white;'>Total number of Vins :"  +JsonByNumberof_vins.length+"</span>"; 
  CreateCharts(myJson);
  EI_Chart(myEi);
  document.getElementById('dateSlider').value= total_Dates[0].key;
});
var startButton = document.getElementById('submitStartButton'),
  stopButton = document.getElementById('submitStopButton');

console.log(myEi);
 //   if(selectedDate == '') {  // use == instead of = here. It will check condition
  //alert("date is not selected");
 
  CreateCharts(myJson);
  EI_Chart(myEi);

 });
  });  

  var addedData=[];
  var addedData_pie=[];
  var addedData_topCausalPart=[];
  var addedData_topDTC=[];
  var addedData_worldMap=[];
  
  function CreateCharts(myJson ,i) {


console.log(myJson);


 d3.selectAll("svg").remove();
   

    

    ///////////////////////////////DOnut CHart///////////////////////////////////////////////////////////
     var div = d3.select("body").append("div").attr("class", "toolTip");
     var $container = $('.chart-container')
    var width = 300,
    height = 200,
    radius = Math.min(width, height) / 2;
    var color = d3.scale.ordinal()
    .range(["#7FFF00", "#FFE4C4", "#FF8C00", "#FFD700", "#CD5C5C"]);

    var legendWidth = 10000;

var arc = d3.svg.arc()
    .outerRadius(radius - 10)
    .innerRadius(radius - 70);

var pie = d3.layout.pie()
    .sort(null)
	 .startAngle(1.1*Math.PI)
    .endAngle(3.1*Math.PI)
    .value(function(d) { return d.values; });

    var JsonByName =[]
    
    JsonByName= d3.nest()
  .key(function(d) { return d.module.substring(0, 3); })
  .rollup(function(v) { return v.length })
  .entries(myJson);

  JsonByName.sort(function(x, y){
   return d3.descending(x.values, y.values);
});

JsonByName.forEach(function(d) {
    d.percentage = d.values  / myJson.length;
    console.log(d.percentage);

});

console.log(i);
if(i>=0){
addedData.push(JsonByName);

var users = addedData.map(o => o).flat();
var holder = {};

users.forEach(function(d) {
  if (holder.hasOwnProperty(d.key)) {
    holder[d.key] = holder[d.key] + d.values;
  } else {
    holder[d.key] = d.values;
  }
});

var obj2 = [];

for (var prop in holder) {
  obj2.push({ key: prop, values: holder[prop] });
}

console.log(obj2);

}

 console.log(addedData);
 console.log(users);

 if(i>=0){

  var topData= obj2.slice(0, 3)

 }
 else{
var topData=JsonByName.slice(0, 3)
 }
// var total = topData.reduce(function(a,b) {
//     return (+a.values)+(+b.values);
// });

console.log(JsonByName);




var svg = d3.select("#svgDonut").append('svg')
    .attr("width", '70%')
    .attr("height", '30%')
    .attr('viewBox','-50 0 290 350')
    .attr('preserveAspectRatio','xMaxYMax')
  .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");


 var g = svg.selectAll(".arc")
      .data(pie(topData))
    .enter().append("g")
      .attr("class", "arc");

  g.append("path")
	.style("fill", function(d) { return color(d.data.key); })
    .transition().delay(function(d,i) {
	return i * 500; }).duration(5000)
	.attrTween('d', function(d) {
		var i = d3.interpolate(d.startAngle+0.1, d.endAngle);
		return function(t) {
			d.endAngle = i(t); 
			return arc(d)
			}
		}); 
  g.append("text") //.attr("transform", "rotate(-60)")
      .attr("transform", function(d) {   var c = arc.centroid(d);
        return "translate(" + c[0]*1.5 +"," + c[1]*1.5 + ")";})
        //return "translate(" + arc.centroid(d) + ")"; })
      .attr("dy", ".35em")
	  .transition()
	  .delay(1000)
      .text(function(d) { return d.data.key +" "+d.data.values; })
      .style("font-size", "25px");


	// define legend
   var legendRectSize = 18;                                  // NEW
         var legendSpacing = 4;    
  // var legend = svg.selectAll('.legend')                     // NEW
  //         .data(color.domain())                                   // NEW
  //         .enter()                                                // NEW
  //         .append('g')                                            // NEW
  //         .attr('class', 'legend')                                // NEW
  //         .attr('transform', function(d, i) {                     // NEW
  //           var height = legendRectSize + legendSpacing;          // NEW
  //           var offset =  height * color.domain().length / 2;     // NEW
  //           var horz = 2 * legendRectSize;                       // NEW
  //           var vert = i * height - offset;                       // NEW
  //           return 'translate(' + width/2 + ',' + vert + ')';        // NEW
  //         });                                                     // NEW
  //       legend.append('rect')                                     // NEW
  //         .attr('width', legendRectSize)                          // NEW
  //         .attr('height', legendRectSize)                         // NEW
  //         .style('fill', color)                                   // NEW
  //         .style('stroke', color);                                // NEW
  //       legend.append('text')                                     // NEW
  //         .attr('x', legendRectSize + legendSpacing)              // NEW
  //         .attr('y', legendRectSize - legendSpacing)
  //         //.style('fill', 'white')              // NEW
  //         .text(function(d) { return d; }); 
          
	d3.selectAll("path").on("mousemove", function(d) {
	    div.style("left", d3.event.pageX+60+"px");
		  div.style("top", d3.event.pageY-55+"px");
		  div.style("display", "inline-block");
    div.html((d.data.key)+"<br>"+(d.data.values)+"<br>"+(d.data.percentage));
});
	  
d3.selectAll("path").on("mouseout", function(d){
    div.style("display", "none");
});
	  
	  
//d3.select("body").transition().style("background-color", "#d3d3d3");
function type(d) {
  d.values = +d.values;
  return d;
}



   
/////////////////////////////////////////////Pie Chart Begins//////////////////////////////

var div_pie = d3.select("body").append("div").attr("class", "toolTip");
    var width_pie = 200,
    height_pie = 200,
    radius_pie = Math.min(width_pie, height_pie) / 2;
    var color_pie = d3.scale.ordinal()
    .range(['#ff4000', '#ffbf00','#bfff00','#ff0080','#8c7373','#660000']);

var arc_pie = d3.svg.arc()
    .outerRadius(radius_pie - 10)
    .innerRadius(0);

var pie_chart = d3.layout.pie()
    .sort(null)
	 .startAngle(1.1*Math.PI)
    .endAngle(3.1*Math.PI)
    .value(function(d) { return d.values; });

    var JsonByNameof_dtc =[]
    
    JsonByNameof_dtc= d3.nest()
  .key(function(d) { return d.dtc_status_conv; })
  .rollup(function(v) { return v.length })
  .entries(myJson);


  JsonByNameof_dtc.sort(function(x, y){
   return d3.descending(x.values, y.values);
});

if(i>=0){
addedData_pie.push(JsonByNameof_dtc);

var pie_added = addedData_pie.map(o => o).flat();
var holder_pie = {};

pie_added.forEach(function(d) {
  if (holder_pie.hasOwnProperty(d.key)) {
    holder_pie[d.key] = holder_pie[d.key] + d.values;
  } else {
    holder_pie[d.key] = d.values;
  }
});

var consolidated_pie = [];

for (var prop in holder_pie) {
  consolidated_pie.push({ key: prop, values: holder_pie[prop] });
}

console.log(consolidated_pie);

}
if(i>=0){
  var topData_pie=consolidated_pie.slice(0, 5)
}
else{
var topData_pie=JsonByNameof_dtc.slice(0, 5);
}
console.log(topData_pie);

//console.log(JsonByNameof_dtc);


var svg_pie = d3.select("#svgPie").append('svg')
.attr("width", '70%')
    .attr("height", '30%')
    .attr('viewBox','-50 0 290 350')
    .attr('preserveAspectRatio','xMinYMin')
  .append("g")
    .attr("transform", "translate(" + Math.min(width_pie,height_pie)/ 2 + "," + Math.min(width_pie,height_pie)/ 2 + ")");


 var g_pie = svg_pie.selectAll(".arc")
      .data(pie(topData_pie))
    .enter().append("g")
      .attr("class", "arc");

  g_pie.append("path")
	.style("fill", function(d) { return color_pie(d.data.key); })
    .transition().delay(function(d,i) {
	return i * 500; }).duration(5000)
	.attrTween('d', function(d) {
		var i_pie = d3.interpolate(d.startAngle+0.1, d.endAngle);
		return function(t) {
			d.endAngle = i_pie(t); 
			return arc_pie(d)
			}
		}); 
  g_pie.append("text")
      .attr("transform", function(d) { var c_pie = arc_pie.centroid(d);
        return "translate(" + c_pie[0]*1.5 +"," + c_pie[1]*1.5 + ")";})
        // return "translate(" + arc_pie.centroid(d) + ")"; })
      .attr("dy", ".35em")
	  .transition()
	  .delay(1000)
      .text(function(d) { return d.data.values; })
      .style("font-size", "20px");;

  // var legendRectSize_Pie = 18;                                  // NEW
  //       var legendSpacing_pie = 4;    
  var legend_pie = svg_pie.selectAll('.legend')                     // NEW
          .data(color_pie.domain())                                   // NEW
          .enter()                                                // NEW
          .append('g')                                            // NEW
          .attr('class', 'legend')                                // NEW
          .attr('transform', function(d, i) {                     // NEW
            var height_pieLeg = legendRectSize + legendSpacing;          // NEW
            var offset_pie =  height_pieLeg * color_pie.domain().length / 2;     // NEW
            var horz_pie = 2 * legendRectSize;                       // NEW
            var vert_pie = i * height_pieLeg - offset_pie;                       // NEW
            return 'translate(' + width_pie/2 + ',' + vert_pie + ')';        // NEW
          });                                                     // NEW
        legend_pie.append('rect')                                     // NEW
          .attr('width', legendRectSize)                          // NEW
          .attr('height', legendRectSize)                         // NEW
          .style('fill', color_pie)                                   // NEW
          .style('stroke', color_pie);                                // NEW
        legend_pie.append('text')                                     // NEW
          .attr('x', legendRectSize + legendSpacing)              // NEW
          .attr('y', legendRectSize - legendSpacing)  
          .style('fill', 'white')                // NEW
          .text(function(d) { return d; }); 
          


	d3.selectAll("path").on("mousemove", function(d) {
	    div_pie.style("left", d3.event.pageX+10+"px");
		  div_pie.style("top", d3.event.pageY-25+"px");
		  div_pie.style("display", "inline-block");
    div_pie.html((d.data.key)+"<br>"+(d.data.values));
});
	  
d3.selectAll("path").on("mouseout", function(d){
    div_pie.style("display", "none");
});
	  
	  
//d3.select("body").transition().style("background-color", "#d3d3d3");
function type(d) {
  d.values = +d.values;
  return d;
}


///////////////WORLD MAP CHART///////////////////////////////////////////////////////////////////////



var format = d3.format(",");


// Set tooltips
 var tip_worldMap = d3.select("body").append("div").attr("class", "toolTip");//d3.tip()
//             .attr('class', 'd3-tip')
//             .offset([70, 0])
//             .html(function(d) {
//               return "<strong>Country: </strong><span class='details'>" + d.properties.name + "<br></span>" + "<strong>total Count: </strong><span class='details'>" + format(d.population) +"</span>";
//             })

var margin_worldMap = {top: 0, right: 0, bottom: 0, left: 0},
            width_WorldMap =260 - margin_worldMap.left - margin_worldMap.right,
            height_worldMap = 250 - margin_worldMap.top - margin_worldMap.bottom;

var color_worldMap = d3.scale.threshold()
.domain([0,1,10,100,500,1000,5000,10000,500000000,1500000000])
    .range(["rgb(247,251,255)", "rgb(222,235,247)", "rgb(198,219,239)", "rgb(158,202,225)", "rgb(107,174,214)", "rgb(66,146,198)","rgb(33,113,181)","rgb(8,81,156)","rgb(8,48,107)","rgb(3,19,43)"]);

var path_worldMap = d3.geo.path();

var svg_WorldMap = d3.select("#svgworldChart").append('svg')
           // .append("svg")
           .attr("width", '80%')
    .attr("height", '100%')
    .attr('viewBox','-180 -90 590 350')
    .attr('preserveAspectRatio','xMaxYMax')
            .append('g')
            .attr('class', 'map');

var projection = d3.geo.mercator()
                   .scale(100)
                  .translate( [width_WorldMap / 2, height_worldMap / 1.5]);

var path_worldMAp_new = d3.geo.path().projection(projection);

//svg_WorldMap.call(tip_worldMap);
var JsonByNameof_Country = [];
 
JsonByNameof_Country= d3.nest()
.key(function(d) { return d.id;})
 // .key(function(d) { return d.country;})
  
  .rollup(function(v) { return v.length })
  .entries(myJson);


//   if(i>=0){
// addedData_worldMap.push(JsonByNameof_Country);

// var users_map = addedData_worldMap.map(o => o).flat();
// var holder_map = {};

// users_map.forEach(function(d) {
//   if (holder_map.hasOwnProperty(d.key)) {
//     holder_map[d.key] = holder_map[d.key] + d.values;
//   } else {
//     holder_map[d.key] = d.values;
//   }
// });

// var obj_map = [];

// for (var prop in holder_map) {
//   obj_map.push({ key: prop, values: holder_map[prop] });
// }

// console.log(obj_map);

// }

queue()
   .defer(d3.json, "readme-world-110m.json")
  // .defer(d3.tsv, "world_population.tsv")//(JsonByNameof_Country)
  .await(ready);

 function ready(error, data) {

  
var populationById = {};

///JsonCauslaPart_grouping.sort(function(x, y){
//    return  d3.descending(x.values, y.values);});


JsonByNameof_Country.forEach(function(d) {populationById[d.key] = +d.values; });
data.features.forEach(function(d) {d.values = populationById[d.id] });

console.log(populationById);
  svg_WorldMap.append("g")
      .attr("class", "countries")
    .selectAll("path")
      .data(data.features)
    .enter().append("path")
      .attr("d", path_worldMAp_new)
      .style("fill", function(d) { return color_worldMap(populationById[d.id]); })
      .style('stroke', 'blue')
      .style('stroke-width', 1.5)
      .style("opacity",0.8)
      
      // tooltips
        .style("stroke","blue")
        .style('stroke-width', 0.3)
        .on("mousemove", function(d){
          tip_worldMap
              .style("left", d3.event.pageX - 50 + "px")
              .style("top", d3.event.pageY - 70 + "px")
              .style("display", "inline-block")
              .html((d.id) + "<br>" + "Count :" + (d.values));
        })
    		.on("mouseout", function(d){ tip_worldMap.style("display", "none");});

        // .on('mouseover',function(d){
        //   tip_worldMap.show(d,this);

        //   d3.select(this)
        //     .style("opacity", 1)
        //     .style("stroke","blue")
        //     .style("stroke-width",3);
        // })
        // .on('mouseout', function(d){
        //   tip_worldMap.hide(d,this);

        //   d3.select(this)
        //     .style("opacity", 0.8)
        //     .style("stroke","blue")
        //     .style("stroke-width",0.3);
        // });
        var label = svg_WorldMap.selectAll("text")
    .data(data.features)
    .enter()
    .append("text")
      .attr("class", "label")
      .attr("transform", function(d) { return "translate(" + path_worldMAp_new.centroid(d) + ")"; })
      ;//.text(function(d) { return d.values;} );

        svg_WorldMap.append("path")
      .datum(topojson.mesh(data.features, function(a, b) { return a.id !== b.id; }))
       // .datum(topojson.mesh(data.features, function(a, b) { return a !== b; }))
      .attr("class", "names")
      .attr("d", path_worldMAp_new);

console.log("map completed")

}   

//////////////////////////////BAR FAIL PROB CHART START/////////////////////////////////////////////

function getTextWidth(text, fontSize, fontName) {
            c = document.createElement("canvas");
            ctx = c.getContext("2d");
            ctx.font = fontSize + ' ' + fontName;
            return ctx.measureText(text).width;
        }

        function DataSegregator(array, on) {
            var SegData;
            OrdinalPositionHolder = {
                valueOf: function () {
                    thisObject = this;
                    keys = Object.keys(thisObject);
                    keys.splice(keys.indexOf("valueOf"), 1);
                    keys.splice(keys.indexOf("keys"), 1);
                    return keys.length == 0 ? -1 : d3.max(keys, function (d) { return thisObject[d] })
                }
                , keys: function () {
                    keys = Object.keys(thisObject);
                    keys.splice(keys.indexOf("valueOf"), 1);
                    keys.splice(keys.indexOf("keys"), 1);
                    return keys;
                }
            }
            array[0].map(function (d) { return d[on] }).forEach(function (b) {
                value = OrdinalPositionHolder.valueOf();
                OrdinalPositionHolder[b] = OrdinalPositionHolder > -1 ? ++value : 0;
            })

            SegData = OrdinalPositionHolder.keys().map(function () {
                return [];
            });

            array.forEach(function (d) {
                d.forEach(function (b) {
                    SegData[OrdinalPositionHolder[b[on]]].push(b);
                })
            });

            return SegData;
        }


        Data = [
{ Date: "2016-06-14", Categories: [{ Name: "Category1", Value: 368 }, { Name: "Category2", Value: 321 }, { Name: "Category3", Value: 524 }], LineCategory: [{ Name: "Line1", Value: 69 }, { Name: "Line2", Value: 63 }] },
{ Date: "2016-06-15", Categories: [{ Name: "Category1", Value: 521 }, { Name: "Category2", Value: 123 }, { Name: "Category3", Value: 653 }], LineCategory: [{ Name: "Line1", Value: 89 }, { Name: "Line2", Value: 96 }] },
{ Date: "2016-06-17", Categories: [{ Name: "Category1", Value: 368 }, { Name: "Category2", Value: 236 }, { Name: "Category3", Value: 537 }], LineCategory: [{ Name: "Line1", Value: 63 }, { Name: "Line2", Value: 35 }] },
{ Date: "2016-06-18", Categories: [{ Name: "Category1", Value: 423 }, { Name: "Category2", Value: 330 }, { Name: "Category3", Value: 689 }], LineCategory: [{ Name: "Line1", Value: 86 }, { Name: "Line2", Value: 45 }] },
{ Date: "2016-06-19", Categories: [{ Name: "Category1", Value: 601 }, { Name: "Category2", Value: 423 }, { Name: "Category3", Value: 490 }], LineCategory: [{ Name: "Line1", Value: 65 }, { Name: "Line2", Value: 63 }] },
{ Date: "2016-06-20", Categories: [{ Name: "Category1", Value: 412 }, { Name: "Category2", Value: 461 }, { Name: "Category3", Value: 321 }], LineCategory: [{ Name: "Line1", Value: 75 }, { Name: "Line2", Value: 85 }] }
        ]

        var margin_bar = { top: 20, right: 30, bottom: 60, left: 40 },
            width_bar = 260 - margin_bar.left - margin_bar.right,
            height_bar = 400 - margin_bar.top - margin_bar.bottom;

        var textWidthHolder = 0;
        /// Adding Date in LineCategory
        Data.forEach(function (d) {
            d.LineCategory.forEach(function (b) {
                b.Date = d.Date;
            })
        });




        var Categories = new Array();
        // Extension method declaration

        Categories.pro

        var Data;
        var ageNames;
        var x0 = d3.scale.ordinal()
            .rangeRoundBands([0, width_bar], .1);
        var XLine_bar = d3.scale.ordinal()
            .rangeRoundPoints([0, width_bar], .1);
        var x1 = d3.scale.ordinal();

        var y_bar = d3.scale.linear()
            .range([height_bar, 0]);

        var YLine_bar = d3.scale.linear().range([height_bar, 0])
        .domain([0, d3.max(Data, function (d) { return d3.max(d.LineCategory, function (b) { return b.Value }) })]);

        var color_bar = d3.scale.ordinal()
            .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

        var line = d3.svg.line().x(function (d) {
            return x0(d.Date) + x0.rangeBand() / 2;
        }).y(function (d) { return YLine_bar(d.Value) });




        var xAxis_bar = d3.svg.axis()
            .scale(x0)
            .orient("bottom");

        var yAxis_bar = d3.svg.axis()
            .scale(y_bar)
            .orient("left")
            .tickFormat(d3.format(".2s"));

        var YLeftAxis = d3.svg.axis().scale(YLine_bar).orient("right").tickFormat(d3.format(".2s"));

        var svg_bar = d3.select("#svgBar").append("svg")
        .attr("width", '70%')
    .attr("height", '70%')
    .attr('viewBox','-10 -10 290 250')
    .attr('preserveAspectRatio','xMinYMin')
          .append("g")
            .attr("transform", "translate(" + margin_bar.left + "," + margin_bar.top + ")");





        // Bar Data categories
        Data.forEach(function (d) {
            d.Categories.forEach(function (b) {
                if (Categories.findIndex(function (c) { return c.Name===b.Name}) == -1) {
                    b.Type = "bar";
                    console.log(JSON.stringify(b))
                    Categories.push(b)
                }
            })
        });


        // Line Data categories
        Data.forEach(function (d) {
            d.LineCategory.forEach(function (b) {
                if (Categories.findIndex(function (c) { return c.Name === b.Name }) == -1) {
                    b.Type = "line";
                    console.log(JSON.stringify(b))
                    Categories.push(b)
                }
            })
        });

        // Processing Line data
        lineData = DataSegregator(Data.map(function (d) { return d.LineCategory }), "Name");

        // Line Coloring
        LineColor = d3.scale.ordinal();
        LineColor.domain(Categories.filter(function (d) { return d.Type == "line" }).map(function (d) { return d.Name }));
        LineColor.range(["#d40606", "#06bf00", "#98bdc5", "#671919", "#0b172b"])
        x0.domain(Data.map(function (d) { return d.Date; }));
        XLine_bar.domain(Data.map(function (d) { return d.Date; }));
        x1.domain(Categories.filter(function (d) { return d.Type == "bar" }).map(function (d) { return d.Name})).rangeRoundBands([0, x0.rangeBand()]);
        y_bar.domain([0, d3.max(Data, function (d) { return d3.max(d.Categories, function (d) { return d.Value; }); })]);

        svg_bar.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height_bar + ")")
            .call(xAxis_bar)
            .style('fill','white');

        svg_bar.append("g")
           .attr("class", "y axis")
            .attr("transform", "translate(" + (width_bar) + ",0)")
           .call(YLeftAxis)
           .append("text")
           .attr("transform", "rotate(-90)")
           .attr("y", 10)

           .attr("dy", ".71em")
           .style("text-anchor", "end")
           .text("Percent");

        svg_bar.append("g")
            .attr("class", "y axis")
            .call(yAxis_bar).style('fill','white')
          .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Failure Probab.");


        var state = svg_bar.selectAll(".state")
            .data(Data)
          .enter().append("g")
            .attr("class", "state")
            .attr("transform", function (d) { return "translate(" + x0(d.Date) + ",0)"; });
           
  
        state.selectAll("rect")
            .data(function (d) { return d.Categories; })
          .enter().append("rect")
            .attr("width", x1.rangeBand())
            .attr("x", function (d) { return x1(d.Name); })
            .attr("y", function (d) { return y_bar(d.Value); })
            //.attr("height", function (d) { return height - y(d.Value); })
            .style("fill", function (d) { return color_bar(d.Name); })
            .transition().delay(5000).ease('linear').attrTween("height", function (d) {
                var i = d3.interpolate(0, height_bar - y_bar(d.Value));
                return function (t)
                {
                    return i(t);
                }
            });

        // drawaing lines
        svg_bar.selectAll(".lines").data(lineData).enter().append("g").attr("class", "line")
        .each(function (d) {
            Name=d[0].Name
            d3.select(this).append("path").attr("d", function (b) { return line(b) }).style({ "stroke-width": "2px", "fill": "none" }).style("stroke", LineColor(Name)).transition().duration(1500);
        })


        // Legends

        var LegendHolder = svg_bar.append("g").attr("class", "legendHolder");
        var legend = LegendHolder.selectAll(".legend")
            .data(Categories.map(function (d) { return {"Name":d.Name,"Type":d.Type}}))
          .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function (d, i) { return "translate(0," +( height_bar+ margin_bar.bottom/2 )+ ")"; })
            .each(function (d,i) {
                //  Legend Symbols


                d3.select(this).append("rect")
                .attr("width", function () { return 18 })
                .attr("x", function (b) {

                    left = (i+1) * 15 + i * 18 + i * 5 + textWidthHolder;
                    return left;
                })
                 .attr("y", function (b) { return b.Type == 'bar'?0:7})
                .attr("height", function (b) { return b.Type== 'bar'? 18:5 })
                .style("fill", function (b) { return b.Type == 'bar' ? color_bar(d.Name) : LineColor(d.Name) });

                //  Legend Text

                d3.select(this).append("text")
                .attr("x", function (b) {

                    left = (i+1) * 15 + (i+1) * 18 + (i + 1) * 5 + textWidthHolder;

                    return left;
                })
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "start")
                .text(d.Name);

                textWidthHolder += getTextWidth(d.Name, "10px", "calibri");
            });


        // Legend Placing

        d3.select(".legendHolder").attr("transform", function (d) {
            thisWidth = d3.select(this).node().getBBox().width_bar;
            return "translate(" + ((width_bar) / 2 - thisWidth / 2) + ",0)";
        })



/////////////////////////////////////////Bar Failure Prob Chart Ends//////////////////////////////////////////////////////////////////////


// ///////////////////////////////////////BAR CHART CAUSAL PART STARTS/////////////////////////////////
var margin_causalPartBar = {top: 20, right: 20, bottom: 30, left: 40},
    width_causalPartBar = 560 - margin_causalPartBar.left - margin_causalPartBar.right,
    height_causalPartBar = 250 - margin_causalPartBar.top - margin_causalPartBar.bottom;

  // Tooltips
  // var tooltip_causalPartBar  = 
  //     d3.tip()
  // .attr('class', 'd3-tip')
  // .offset([-10, 0])
  // .html(function(d) {
  //   return "<strong>"+ d.key +":</strong> <span style='color:red'>" + d.values + "</span>";
  // })
  var tooltip_causalPartBar = d3.select("body").append("div").attr("class", "toolTip");

var x0_causalPartBar = d3.scale.ordinal()
    .rangeRoundBands([0, width_causalPartBar], .1);

var x1_causalPartBar = d3.scale.ordinal();

var y_causalPartBar = d3.scale.linear()
    .range([height_causalPartBar, 0]);

var xAxis_causalPartBar = d3.svg.axis()
    .scale(x0_causalPartBar)
    .tickSize(0)
    .orient("bottom");

var yAxis_causalPartBar = d3.svg.axis()
    .scale(y_causalPartBar)
    .orient("left");

var color_causalPartBar = d3.scale.ordinal()
.range(["rgb(33,113,181)"]);//.range(["#ca0020","#f4a582","#d5d5d5","#92c5de","#0571b0","#ADD8E6","#FFA500","#008000","#FF00FF"]);

var svg_causalPartBar = d3.select('#svgCausalPartBar').append("svg")
    .attr("width", width_causalPartBar + margin_causalPartBar.left + margin_causalPartBar.right)
    .attr("height", height_causalPartBar + margin_causalPartBar.top + margin_causalPartBar.bottom)
  .append("g")
    .attr("transform", "translate(" + margin_causalPartBar.left + "," + margin_causalPartBar.top + ")");

//svg_causalPartBar.call(tooltip_causalPartBar);
// Get the data

 
   var JsonCauslaPart_grouping = d3.nest()
  .key(function(d) { return d.module.substring(0, 3); })
  .key(function(d) { return d.predict; })
  .rollup(function(v) { return v.length })
  .entries(myJson);
//   JsonCauslaPart_grouping.sort(function(x, y){
//    return  d3.descending(x.values, y.values);});



for (let index = 0; index < JsonCauslaPart_grouping.length; index++) {
    JsonCauslaPart_grouping[index].values.sort(function(a, b) {
        return d3.descending( a.values , b.values);
    });
   
    // JsonCauslaPart_grouping[index].values.slice(0,5);
}
// for (let index = 0; index < JsonCauslaPart_grouping.length; index++) {
//   requiredData = JsonCauslaPart_grouping[index].values.filter(function(obj, i) {
//         return i < 5;
//     });
//     console.log(requiredData)
// }
JsonCauslaPart_grouping.filter(function(obj, i) {
	obj.values = obj.values.slice(0,5);
        return obj;
    });

//  console.log(requiredData) 
var topData_causalPartBar = JsonCauslaPart_grouping;

console.log(topData_causalPartBar);

console.log(topData_causalPartBar);
if(topData_causalPartBar.length!=0){
   var categoriesNames = topData_causalPartBar.map(function(d) { return d.key; });
  var rateNames = topData_causalPartBar[0].values.map(function(d) { return d.key; });

  x0_causalPartBar.domain(categoriesNames);
  x1_causalPartBar.domain(rateNames).rangeRoundBands([0, x0_causalPartBar.rangeBand()]);
  y_causalPartBar.domain([0, d3.max(topData_causalPartBar, function(categorie) { return d3.max(categorie.values, function(d) { return d.values; }); })]);

  svg_causalPartBar.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height_causalPartBar + ")")
      .call(xAxis_causalPartBar)
      .style('fill', 'white') ;
  svg_causalPartBar.append("g")
      .attr("class", "y axis")
      .style('opacity','0')
      .call(yAxis_causalPartBar)
  .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style('fill', 'white') 
      .style("text-anchor", "end")
      .style('font-weight','bold')
      .text("Value");

  svg_causalPartBar.select('.y').transition().duration(500).delay(1300).style('opacity','1');

  var slice_causalPartBar = svg_causalPartBar.selectAll(".slice")
      .data(topData_causalPartBar)
      .enter().append("g")
      .attr("class", "g")
      .attr("transform",function(d) { return "translate(" + x0_causalPartBar(d.key) + ",0)"; });

  slice_causalPartBar.selectAll("rect")
      .data(function(d) { return d.values; })
  .enter().append("rect")
      .attr("width", x1_causalPartBar.rangeBand())
      .attr("x", function(d) { return x1_causalPartBar(d.key); })
      .style("fill", function(d) { return color_causalPartBar(d.key) })
      .attr("y", function(d) { return y_causalPartBar(0); })
      .attr("height", function(d) { return height_causalPartBar - y_causalPartBar(0); })
      .on("mousemove", function(d){
        tooltip_causalPartBar
              .style("left", d3.event.pageX - 50 + "px")
              .style("top", d3.event.pageY - 70 + "px")
              .style("display", "inline-block")
              .html((d.key) + "<br>" + "count :" + (d.values));
        })
    		.on("mouseout", function(d){ tooltip_causalPartBar.style("display", "none");});
      // .on('mouseover', tooltip_causalPartBar.show)
      //  .on('mouseout', tooltip_causalPartBar.hide);


  slice_causalPartBar.selectAll("rect")
      .transition()
      .delay(function (d) {return Math.random()*1000;})
      .duration(5000)
      .attr("y", function(d) { return y_causalPartBar(d.values); })
      .attr("height", function(d) { return height_causalPartBar - y_causalPartBar(d.values); });

  //Legend
  // var legend_causalPartBar = svg_causalPartBar.selectAll(".legend")
  //     .data(topData_causalPartBar[0].values.map(function(d) { return d.key; }).reverse())
  // .enter().append("g")
  //     .attr("class", "legend")
  //     .attr("transform", function(d,i) { return "translate(200," + i * 30 + ")"; })
  //   // .attr("transform", function(d, i) { return "translate(" + (-700+i*100) + "," + 0 + ")"; })
  //   //.attr('transform', function(d, i) { return "translate(" + -40*i + "," + 0 + ")"; })
  //   .attr("width", 36) 
  //   .style("opacity","0");

  // legend_causalPartBar.append("rect")
  //     .attr("x", width )
  //     .attr("width", 18)
  //     .attr("height", 18)
  //     .style("fill", function(d) { return color_causalPartBar(d); });

  // legend_causalPartBar.append("text")
  //     .attr("x", width - 10)
  //     .attr("y", 9)
  //     .attr("dy", ".35em")
  //     .style("text-anchor", "end")
  //     .text(function(d) {return d; });

  // legend_causalPartBar.transition().duration(5000).delay(function(d,i){ return 1300 + 100 * i; }).style("opacity","1");
}
////////////////////////////////////////// DTCfaultGrouping starts////////////////////////////////////////////

var margin_DTCfaultGrouping = {top: 20, right: 20, bottom: 30, left: 40},
    width_DTCfaultGrouping = 560 - margin_DTCfaultGrouping.left - margin_DTCfaultGrouping.right,
    height_DTCfaultGrouping = 250 - margin_DTCfaultGrouping.top - margin_DTCfaultGrouping.bottom;


  //   var tooltip_DTCfaultGrouping  = 
  //     d3.tip()
  // .attr('class', 'd3-tip')
  // .offset([-10, 0])
  // .html(function(d) {
  //   return "<strong>"+ d.key +":</strong> <span style='color:red'>" + d.values + "</span>";
  // })
  var tooltip_DTCfaultGrouping = d3.select("body").append("div").attr("class", "toolTip");

var x0_DTCfaultGrouping = d3.scale.ordinal()
    .rangeRoundBands([0, width_DTCfaultGrouping], .1);

var x1_DTCfaultGrouping = d3.scale.ordinal();

var y_DTCfaultGrouping = d3.scale.linear()
    .range([height_DTCfaultGrouping, 0]);

var xAxis_DTCfaultGrouping = d3.svg.axis()
    .scale(x0_DTCfaultGrouping)
    .tickSize(0)
    .orient("bottom");

var yAxis_DTCfaultGrouping = d3.svg.axis()
    .scale(y_DTCfaultGrouping)
    .orient("left");

var color_DTCfaultGrouping = d3.scale.ordinal()
    .range(["rgb(33,113,181)"]);//(["#ca0020","#f4a582","#d5d5d5","#92c5de","#0571b0"]);

var svg_DTCfaultGrouping = d3.select('#topDtcgroup').append("svg")
    .attr("width", width_DTCfaultGrouping + margin_DTCfaultGrouping.left + margin_DTCfaultGrouping.right)
    .attr("height", height_DTCfaultGrouping + margin_DTCfaultGrouping.top + margin_DTCfaultGrouping.bottom)
  .append("g")
    .attr("transform", "translate(" + margin_DTCfaultGrouping.left + "," + margin_DTCfaultGrouping.top + ")");

//svg_DTCfaultGrouping.call(tooltip_DTCfaultGrouping);
// Get the data
  //d3.json("new.json", function(error, data) {
   //////////Grouping Bar Chart /////////////////////////////////////////////

   var Json_DTCfaultGrouping = d3.nest()
  .key(function(d) { return d.base_dtc; })
  .key(function(d) { return d.fault_type_description; })
  .rollup(function(v) { return v.length })
  .entries(myJson);


  for (let index = 0; index < Json_DTCfaultGrouping.length; index++) {
    Json_DTCfaultGrouping[index].values.sort(function(a, b) {
        return d3.descending( a.values , b.values);
    });
   
    // JsonCauslaPart_grouping[index].values.slice(0,5);
}
// for (let index = 0; index < JsonCauslaPart_grouping.length; index++) {
//   requiredData = JsonCauslaPart_grouping[index].values.filter(function(obj, i) {
//         return i < 5;
//     });
//     console.log(requiredData)
// }
Json_DTCfaultGrouping.filter(function(obj, i) {
	obj.values = obj.values.slice(0,5);
        return obj;
    });

//     if(i>=0){
// addedData_topDTC.push(Json_DTCfaultGrouping);

// var dtcgroup_added = addedData_topDTC.map(o => o.values[i]).flat();
// console.log(dtcgroup_added);
// var holder_topdtcgroup = {};

// dtcgroup_added.forEach(function(d) {
//   if (holder_topdtcgroup.hasOwnProperty(d.key)) {
//     holder_topdtcgroup[d.key] = holder_topdtcgroup[d.key] + d.values;
//   } else {
//     holder_topdtcgroup[d.key] = d.values;
//   }
// });

// var consolidated_topdtcgroup = [];

// for (var prop in holder_topdtcgroup) {
//   consolidated_topdtcgroup.push({ key: prop, values: holder_topdtcgroup[prop] });
// }

// console.log(consolidated_topdtcgroup);

//}

// if(i>=0){
//   var topData_DTCfaultGrouping=consolidated_topdtcgroup.slice(0,5);
// }
// else{
var topData_DTCfaultGrouping=Json_DTCfaultGrouping.slice(0,5);
//}
// console.log(topData_DTCfaultGrouping);
if(topData_DTCfaultGrouping.length!=0){
   var categoriesNames_DTCfaultGrouping = topData_DTCfaultGrouping.map(function(d) { return d.key; });
   var rateNames_DTCfaultGrouping;
   topData_DTCfaultGrouping.forEach(function(d,i){
     rateNames_DTCfaultGrouping = topData_DTCfaultGrouping[i].values.map(function(d) { return d.key; });

  })
//   var rateNames_DTCfaultGrouping = topData_DTCfaultGrouping[0].values.map(function(d) { return d.key; });

  x0_DTCfaultGrouping.domain(categoriesNames_DTCfaultGrouping);
  x1_DTCfaultGrouping.domain(rateNames_DTCfaultGrouping).rangeRoundBands([0, x0_DTCfaultGrouping.rangeBand()]);
  y_DTCfaultGrouping.domain([0, d3.max(topData_DTCfaultGrouping, function(categorie_DTCfaultGrouping) { return d3.max(categorie_DTCfaultGrouping.values, function(d) { return d.values; }); })]);

  svg_DTCfaultGrouping.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height_DTCfaultGrouping + ")")
      .call(xAxis_DTCfaultGrouping)
      .style('fill', 'white');

  svg_DTCfaultGrouping.append("g")
      .attr("class", "y axis")
      .style('opacity','0')
      .call(yAxis_DTCfaultGrouping)
  .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style('fill', 'white')   
      .style("text-anchor", "end")
      .style('font-weight','bold')
      .text("Value");

  svg_DTCfaultGrouping.select('.y').transition().duration(500).delay(1300).style('opacity','1');

  var slice_DTCfaultGrouping = svg_DTCfaultGrouping.selectAll(".slice")
      .data(topData_DTCfaultGrouping)
      .enter().append("g")
      .attr("class", "g")
      .attr("transform",function(d) { return "translate(" + x0_DTCfaultGrouping(d.key) + ",0)"; });

  slice_DTCfaultGrouping.selectAll("rect")
      .data(function(d) { return d.values; })
  .enter().append("rect")
      .attr("width", x1_DTCfaultGrouping.rangeBand())
      .attr("x", function(d) { return x1_DTCfaultGrouping(d.key); })
      .style("fill", function(d) { return color_DTCfaultGrouping(d.key) })
      .attr("y", function(d) { return y_DTCfaultGrouping(0); })
      .attr("height", function(d) { return height_DTCfaultGrouping - y_DTCfaultGrouping(0); })
      .on("mousemove", function(d){
            tooltip_DTCfaultGrouping
              .style("left", d3.event.pageX - 50 + "px")
              .style("top", d3.event.pageY - 70 + "px")
              .style("display", "inline-block")
              .html((d.key) + "<br>" + "count :" + (d.values));
        })
    		.on("mouseout", function(d){ tooltip_DTCfaultGrouping.style("display", "none");});
      // .on('mouseover', tooltip_DTCfaultGrouping.show)
      //  .on('mouseout', tooltip_DTCfaultGrouping.hide);


  slice_DTCfaultGrouping.selectAll("rect")
      .transition()
      .delay(function (d) {return Math.random()*1000;})
      .duration(5000)
      .attr("y", function(d) { return y_DTCfaultGrouping(d.values); })
      .attr("height", function(d) { return height_DTCfaultGrouping - y_DTCfaultGrouping(d.values); });

    //    slice_DTCfaultGrouping.append("text")
    // .attr("class", "up")
    // .attr("x", 12)
    // .attr("dy", "1.2em")
    // .attr("text-anchor", "left")
    // .text(function(d,i) { return d.values[i].key; })
    // .style("fill", "#ffffff");


  //Legend
  // var legend_DTCfaultGrouping = svg_DTCfaultGrouping.selectAll(".legend")
  //     .data(topData_DTCfaultGrouping[0].values.map(function(d) { return d.key; }))
  // .enter().append("g")
  //     .attr("class", "legend")
  //     .attr("transform", function(d,i) { return "translate(250," + i * 30 + ")"; })
  //   // .attr("transform", function(d, i) { return "translate(" + (-700+i*100) + "," + 0 + ")"; })
  //   //.attr('transform', function(d, i) { return "translate(" + -40*i + "," + 0 + ")"; })
  //   .attr("width", 36) 
  //   .style("opacity","0");

  // legend_DTCfaultGrouping.append("rect")
  //     .attr("x", width )
  //     .attr("width", 18)
  //     .attr("height", 18)
  //     .style("fill", function(d) { return color_DTCfaultGrouping(d); });

  // legend_DTCfaultGrouping.append("text")
  //     .attr("x", width - 10)
  //     .attr("y", 9)
  //     .attr("dy", ".35em")
  //     .style("text-anchor", "end")
  //     .text(function(d) {return d; });

  // legend_DTCfaultGrouping.transition().duration(5000).delay(function(d,i){ return 1300 + 100 * i; }).style("opacity","1");
}
////////////////////////////////////Risk Measure///////////////////////////

var JsonRiskMeasure = d3.nest()
  .key(function(d) { return d.session_date; })
  .key(function(d) { return d.risk_measure; })
  .rollup(function(v) { return v.length })
  .entries(myJson);
//   JsonRiskMeasure.sort(function(x, y){
//    return d3.descending(x.values, y.values);
// });
JsonRiskMeasure.sort(function(x, y){
     console.log(Date(x.key));
     return new Date(x.key) - new Date(y.key);
   //return d3.ascending(Date(x.key), Date(y.key));
});
console.log(JsonRiskMeasure);

if(JsonRiskMeasure.length!=0){
  var tip_Riskmeasure = d3.select("body").append("div").attr("class", "toolTip")

var margin_riskMeasure = {
          top: 30,
          right: 40,
          bottom: 30,
          left: 50
        },
          width_riskMeasure = 450 - margin_riskMeasure.left - margin_riskMeasure.right,
          height_riskMeasure = 360 - margin_riskMeasure.top - margin_riskMeasure.bottom;

        var parseDate_riskMeasure = d3.time.format("%Y-%m-%d").parse;// d3.time.format("%d-%m-%y").parse;

        var x_riskMeasure = d3.time.scale().range([0, width_riskMeasure]);
        var y_riskMeasure = d3.scale.linear().range([height_riskMeasure, 0]);

        var xAxis_riskMeasure = d3.svg.axis().scale(x_riskMeasure)
          .orient("bottom").ticks(7);

        var yAxis_riskMeasure = d3.svg.axis().scale(y_riskMeasure)
          .orient("left").ticks(7);

        var valueline = d3.svg.line()
          .x(function (d) {
            return x_riskMeasure(d.date);
          })
          .y(function (d) {
            return y_riskMeasure(d.Low);
          });

        var valueline2 = d3.svg.line()
          .x(function (d) {
            return x_riskMeasure(d.date);
          })
          .y(function (d) {
            return y_riskMeasure(d.High);
          });

        var svg_riskMeasure = d3.select("#riskMeasure")
          .append("svg")
          .attr("width", width_riskMeasure + margin_riskMeasure.left + margin_riskMeasure.right)
          .attr("height", height_riskMeasure + margin_riskMeasure.top + margin_riskMeasure.bottom)
          .append("g")
          .attr("transform", "translate(" + margin_riskMeasure.left + "," + margin_riskMeasure.top + ")");

        // Get the data
        //d3.myArr(myArr, function(error, data) {
        var myArr = []
        JsonRiskMeasure.forEach(function (d, i) {
          console.log(d)
          myArr.push(
            {
              date: new Date(d.key),
              Low: d.values[0].values,
              High: d.values[1].values

            }
          )
        });
        console.log(myArr)
        // for(let i= 0; i< JsonRiskMeasure.length; ++i)

        // Scale the range of the data
        x_riskMeasure.domain(d3.extent(myArr, function (d) {
          return d.date;
        }));
        y_riskMeasure.domain([0, d3.max(myArr, function (d) {
          return Math.max(d.Low, d.High);
        })]);

     var path_risk_1=   svg_riskMeasure.append("path") // Add the valueline path.
          .attr("class", "line")
          .style('stroke', 'Red')
          .attr("d", valueline(myArr));

  var path_risk_2 =      svg_riskMeasure.append("path") // Add the valueline2 path.
          .attr("class", "line")
          .style("stroke", "Yellow")

          .attr("d", valueline2(myArr));



        svg_riskMeasure.append("g") // Add the X Axis
          .attr("class", "x axis")
          .attr("transform", "translate(0," + height_riskMeasure + ")")
          .call(xAxis_riskMeasure);

        svg_riskMeasure.append("g") // Add the Y Axis
          .attr("class", "y axis")
          .call(yAxis_riskMeasure);

        svg_riskMeasure.append('g')
          .classed('labels-group', true)
          .selectAll('text')
          .data(myArr)
          .enter()
          .append('text')
          .classed('label', true)
          .attr({
            'x': function (d, i) {
              return x_riskMeasure(d.date);
            },
            'y': function (d, i) {
              return y_riskMeasure(d.Low);
            }
          })
          .text(function (d, i) {
            return d.High;
          });

 //Legend
 var color_RiskGroup = d3.scale.ordinal()
     .range(["#ec0000","#ecca00"]);
  var legend_RiskGroup = svg_riskMeasure.selectAll(".legend")
      .data(JsonRiskMeasure[0].values.map(function(d) { return d.key; }).reverse())
  .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d,i) { return "translate(0," + i * 30 + ")"; })
    // .attr("transform", function(d, i) { return "translate(" + (-700+i*100) + "," + 0 + ")"; })
    //.attr('transform', function(d, i) { return "translate(" + -40*i + "," + 0 + ")"; })
    .attr("width", 36) 
    .style("opacity","0");

  legend_RiskGroup.append("rect")
      .attr("x", width_riskMeasure - 5)
      .attr("width", 18)
      .attr("height", 18)
    //  .style("fill", "Red")
      .style("fill", function(d) { return color_RiskGroup(d); });
     // .style("fill", "Yellow");

  legend_RiskGroup.append("text")
      .attr("x", width_riskMeasure - 10)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) {return d; });

  legend_RiskGroup.transition().duration(5000).delay(function(d,i){ return 1300 + 100 * i; }).style("opacity","1");




        // svg_riskMeasure.append("text")
        //   .attr("transform", "translate(" + (width_riskMeasure + 3) + "," + y_riskMeasure(myArr[0].High) + ")")
        //   .attr("dy", ".35em")
        //   .attr("text-anchor", "start")
        //   .style("fill", "red")
        //   .text("");

        // svg_riskMeasure.append("text")
        //   .attr("transform", "translate(" + (width_riskMeasure + 3) + "," + yAxis_riskMeasure(myArr[0].Low) + ")")
        //   .attr("dy", ".35em")
        //   .attr("text-anchor", "start")
        //   .style("fill", "steelblue")
        //   .text("");

   

 }

//////////////////////////RiskMeasureBar Chart////////////////////////////////////////


// var margin_RiskGroup = {top: 20, right: 20, bottom: 30, left: 40},
//     width_RiskGroup = 300 - margin_RiskGroup.left - margin_RiskGroup.right,
//     height_RiskGroup = 250 - margin_RiskGroup.top - margin_RiskGroup.bottom;



//   ///////////////////////
//   // Tooltips
//    var tooltip_riskMeasureGroup  = d3.select("body").append("div").attr("class", "toolTip");
//   //     d3.tip()
//   // .attr('class', 'd3-tip')
//   // .offset([-2, 0])
//   // .html(function(d) {
//   //   return "<strong>"+ d.key +":</strong> <span style='color:red'>" + d.values + "</span>";
//   // })

// var x0_RiskGroup = d3.scale.ordinal()
//     .rangeRoundBands([0, width_RiskGroup], .1);

// var x1_RiskGroup = d3.scale.ordinal();

// var y_RiskGroup = d3.scale.linear()
//     .range([height_RiskGroup, 0]);

// var xAxis_RiskGroup = d3.svg.axis()
//     .scale(x0_RiskGroup)
//     .tickSize(0)
//     .orient("bottom");

// var yAxis_RiskGroup = d3.svg.axis()
//     .scale(y_RiskGroup)
//     .orient("left");

// var color_RiskGroup = d3.scale.ordinal()
//     .range(["#ca0020","#f4a582","#d5d5d5","#92c5de","#0571b0"]);

// var svg_RiskGroup = d3.select('#riskMeasure').append("svg")
// .attr("width", '50%')
//     .attr("height", '70%')
//     .attr('viewBox','0 0 390 250')
//     .attr('preserveAspectRatio','xMaxYMax')
//     // .attr("width", width_RiskGroup + margin_RiskGroup.left + margin_RiskGroup.right)
//     // .attr("height", height_RiskGroup + margin_RiskGroup.top + margin_RiskGroup.bottom)
//   .append("g")
//     .attr("transform", "translate(" + margin_RiskGroup.left + "," + margin_RiskGroup.top + ")");

// //svg_RiskGroup.call(tooltip_riskMeasureGroup);
// // Get the data
//   //d3.json("new.json", function(error, data) {
//    //////////Grouping Bar Chart /////////////////////////////////////////////

//    var Json_RiskGroup = d3.nest()
//   .key(function(d) { return d.predict; })
//   .key(function(d) { return d.risk_measure; })
//   .rollup(function(v) { return v.length })
//   .entries(myJson);
//   Json_RiskGroup.sort(function(x, y){
//    return d3.descending(x.values, y.values);
// });

// var topData_RiskGroup=Json_RiskGroup.slice(0, 5)

//  console.log(topData_RiskGroup);
// if(topData_RiskGroup.length!=0){
//    var categoriesNames_RiskGroup = topData_RiskGroup.map(function(d) { return d.key; });
//   var rateNames_RiskGroup = topData_RiskGroup[0].values.map(function(d) { return d.key; });
//   console.log(categoriesNames_RiskGroup)

//   x0_RiskGroup.domain(categoriesNames_RiskGroup);
//   x1_RiskGroup.domain(rateNames_RiskGroup).rangeRoundBands([0, x0_RiskGroup.rangeBand()]);
//   y_RiskGroup.domain([0, d3.max(topData_RiskGroup, function(categorie_RiskGroup) { return d3.max(categorie_RiskGroup.values, function(d) { return d.values; }); })]);

//   svg_RiskGroup.append("g")
//       .attr("class", "x axis")
//       .attr("transform", "translate(0," + height_RiskGroup + ")")
//       .call(xAxis_RiskGroup)
//       .selectAll("text")	
//             .style("text-anchor", "end")
//             .style("fill", "black")
//             .attr("dx", "-.8em")
//             .attr("dy", ".15em")
//             .attr("transform", function(d) {
//                 return "rotate(-40)" 
//                 });

//   svg_RiskGroup.append("g")
//       .attr("class", "y axis")
//       .style('opacity','0')
//       .call(yAxis_RiskGroup)
//   .append("text")
//       .attr("transform", "rotate(-90)")
//       .attr("y", 6)
//       .attr("dy", ".71em")
//       .style('fill', 'white')   
//       .style("text-anchor", "end")
//       .style('font-weight','bold')
//       .text("Value");

//   svg_RiskGroup.select('.y').transition().duration(500).delay(1300).style('opacity','1');

//   var slice_RiskGroup = svg_RiskGroup.selectAll(".slice")
//       .data(topData_RiskGroup)
//       .enter().append("g")
//       .attr("class", "g")
//       .attr("transform",function(d) { return "translate(" + x0_RiskGroup(d.key) + ",0)"; });

//   slice_RiskGroup.selectAll("rect")
//       .data(function(d) { return d.values; })
//   .enter().append("rect")
//       .attr("width", x1_RiskGroup.rangeBand())
//       .attr("x", function(d) { return x1_RiskGroup(d.key); })
//       .style("fill", function(d) { return color_RiskGroup(d.key) })
//       .attr("y", function(d) { return y_RiskGroup(0); })
//       .attr("height", function(d) { return height_RiskGroup - y_RiskGroup(0); })
//       .on("mousemove", function(d){
//         tooltip_riskMeasureGroup
//               .style("left", d3.event.pageX - 50 + "px")
//               .style("top", d3.event.pageY - 70 + "px")
//               .style("display", "inline-block")
//               .html((d.key) + "<br>" + "count :" + (d.values));
//         })
//     		.on("mouseout", function(d){ tooltip_riskMeasureGroup.style("display", "none");});
      
      
//       // .on('mouseover', tooltip_riskMeasureGroup.show)
//       //  .on('mouseout', tooltip_riskMeasureGroup.hide);

//       // .on("mouseover", function(d) {
//       //     d3.select(this).style("fill", d3.rgb(color_RiskGroup(d.key)).darker(2));
//       // })
//       // .on("mouseout", function(d) {
//       //     d3.select(this).style("fill", color_RiskGroup(d.key));
//       // });

//   slice_RiskGroup.selectAll("rect")
//       .transition()
//       .delay(function (d) {return Math.random()*1000;})
//       .duration(5000)
//       .attr("y", function(d) { return y_RiskGroup(d.values); })
//       .attr("height", function(d) { return height_RiskGroup - y_RiskGroup(d.values); });

//   //Legend
//   var legend_RiskGroup = svg_RiskGroup.selectAll(".legend")
//       .data(topData_RiskGroup[0].values.map(function(d) { return d.key; }).reverse())
//   .enter().append("g")
//       .attr("class", "legend")
//       .attr("transform", function(d,i) { return "translate(0," + i * 30 + ")"; })
//     // .attr("transform", function(d, i) { return "translate(" + (-700+i*100) + "," + 0 + ")"; })
//     //.attr('transform', function(d, i) { return "translate(" + -40*i + "," + 0 + ")"; })
//     .attr("width", 36) 
//     .style("opacity","0");

//   legend_RiskGroup.append("rect")
//       .attr("x", width_RiskGroup - 10)
//       .attr("width", 18)
//       .attr("height", 18)
//       .style("fill", function(d) { return color_RiskGroup(d); });

//   legend_RiskGroup.append("text")
//       .attr("x", width_RiskGroup - 10)
//       .attr("y", 9)
//       .attr("dy", ".35em")
//       .style("text-anchor", "end")
//       .text(function(d) {return d; });

//   legend_RiskGroup.transition().duration(50000).delay(function(d,i){ return 1300 + 100 * i; }).style("opacity","1");

//       }




}
var addedData_Ei=[];

function EI_Chart(myEi ,i){

  var setup = function(targetID){
	//Set size of svg element and chart
	var margin_EI = {top: 0, right: 0, bottom: 0, left: 0},
		width_EI = 500 - margin_EI.left - margin_EI.right,
		height_EI = 255 - margin_EI.top - margin_EI.bottom,
		categoryIndent = 4*15 + 5,
		defaultBarWidth = 2000;

	//Set up scales
	var x_EI = d3.scale.linear()
	  .domain([0,defaultBarWidth])
	  .range([0,width_EI]);
	var y_EI = d3.scale.ordinal()
	  .rangeRoundBands([0, height_EI], 0.1, 0);

	//Create SVG element
	d3.select(targetID).selectAll("svg").remove()
	var svg_EI = d3.select(targetID).append("svg")
		.attr("width", width_EI + margin_EI.left + margin_EI.right)
		.attr("height", height_EI + margin_EI.top + margin_EI.bottom)
	  .append("g")
		.attr("transform", "translate(" + margin_EI.left + "," + margin_EI.top + ")");
	
	//Package and export settings
	var settings = {
	  margin:margin_EI, width:width_EI, height:height_EI, categoryIndent:categoryIndent,
	  svg:svg_EI, x:x_EI, y:y_EI
	}
	return settings;
}

var redrawChart = function(targetID, newdata) {

	//Import settings
	var margin=settings.margin, width=settings.width, height=settings.height, categoryIndent=settings.categoryIndent, 
	svg=settings.svg, x=settings.x, y=settings.y;

	//Reset domains
	y.domain(newdata.sort(function(a,b){
	  return b.count - a.count;
	})
	  .map(function(d) { return d.ei_id; }));
	var barmax = d3.max(newdata, function(e) {
	  return e.count
    });
    //console.log(barmax);
	x.domain([0,barmax]);

	/////////
	//ENTER//
	/////////

	//Bind new data to chart rows 

	//Create chart row and move to below the bottom of the chart
	var chartRow = svg.selectAll("g.chartRow")
	  .data(newdata, function(d){ return d.ei_id});
	var newRow = chartRow
	  .enter()
	  .append("g")
	  .attr("class", "chartRow")
	  .attr("transform", "translate(0," + height + margin.top + margin.bottom + ")");

	//Add rectangles
	newRow.insert("rect")
	  .attr("class","bar")
	  .attr("x", 0)
	  .attr("opacity",0)
	  .attr("height", y.rangeBand())
	  .attr("width", function(d) { return x(d.count);}) 

	//Add value labels
	newRow.append("text")
	  .attr("class","label")
	  .attr("y", y.rangeBand()/2)
	  .attr("x",0)
	  .attr("opacity",0)
	  .attr("dy",".35em")
	  .attr("dx","0.5em")
	  .text(function(d){return d.count;}); 
	
	//Add Headlines
	newRow.append("text")
	  .attr("class","category")
	  .attr("text-overflow","ellipsis")
	  .attr("y", y.rangeBand()/2)
	  .attr("x",categoryIndent)
	  .attr("opacity",0)
	  .attr("dy",".35em")
	  .attr("dx","0.5em")
	  .text(function(d){return d.ei_id});


	//////////
	//UPDATE//
	//////////
	
	//Update bar widths
	chartRow.select(".bar").transition()
	  .duration(300)
	  .attr("width", function(d) { return x(d.count);})
	  .attr("opacity",1);

	//Update data labels
	chartRow.select(".label").transition()
	  .duration(300)
	  .attr("opacity",1)
	  .tween("text", function(d) { 
    var i = d3.interpolate(+this.textContent.replace(/\,/g,''), +d.count);
		return function(t) {
		  this.textContent = Math.round(i(t));
		};
	  });

	//Fade in categories
	chartRow.select(".category").transition()
	  .duration(300)
	  .attr("opacity",1);


	////////
	//EXIT//
	////////

	//Fade out and remove exit elements
	chartRow.exit().transition()
	  .style("opacity","0")
	  .attr("transform", "translate(0," + (height + margin.top + margin.bottom) + ")")
	  .remove();


	////////////////
	//REORDER ROWS//
	////////////////

	var delay = function(d, i) { return 200 + i * 30; };

	chartRow.transition()
		.delay(delay)
		.duration(1000)
		.attr("transform", function(d){ return "translate(0," + y(d.ei_id) + ")"; });
};



//Pulls data
//Since our data is fake, adds some random changes to simulate a data stream.
//Uses a callback because d3.json loading is asynchronous
var pullData = function(settings,callback){
	//d3.json("fakeData.json", function (err, data){
      
    //if (err) return console.warn(err);
    
 
        var data = myEi;



    if(i>=0){
addedData_Ei.push(data);

var ei_added = addedData_Ei.map(o => o).flat();
console.log(ei_added);
var holder = {};

ei_added.forEach(function(d) {
  if (holder.hasOwnProperty(d.ei_id)) {
    holder[d.ei_id] = holder[d.ei_id] + d.count;
  } else {
    holder[d.ei_id] = d.count;
  }
});

var consolidated_ei = [];

for (var prop in holder) {
  consolidated_ei.push({ ei_id: prop, count: holder[prop] });
}

console.log(consolidated_ei);

}


console.log(data);
if(i>=0){
  var newData=consolidated_ei;
}
else{
    var newData = data;
}
		data.forEach(function(d,i){
			var newValue = +d.count + Math.floor((Math.random()*5))
			newData[i].count = newValue <= 0 ? 10 : newValue
		})

		newData = formatData(newData);

		callback(settings,newData);
 	
}


//Sort data in descending order and take the top 10 values
var formatData = function(data){
    return data.sort(function (a, b) {
        return b.count - a.count;
      })
	  .slice(0, 5);
}

//I like to call it what it does
var redraw = function(settings){
	pullData(settings,redrawChart)
}

//setup (includes first draw)
var settings = setup('#chart');
redraw(settings)

//Repeat every 3 seconds
setInterval(function(){
	redraw(settings)
}, 3000);


}

</script>


<script>
  
 
</script>


        </script>