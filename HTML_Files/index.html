
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Dark Admin</title>

    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" type="text/css" href="css/local.css" />
<style>
.side-nav {
width: 125px;
    
}

/* body
{
    height: 100%;
    overflow: hidden;
}
 */

</style>
    <script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>

    <!-- you need to include the shieldui css and js assets in order for the charts to work -->
    <link rel="stylesheet" type="text/css" href="http://www.shieldui.com/shared/components/latest/css/light-bootstrap/all.min.css" />
    <link id="gridcss" rel="stylesheet" type="text/css" href="http://www.shieldui.com/shared/components/latest/css/dark-bootstrap/all.min.css" />

    <script type="text/javascript" src="http://www.shieldui.com/shared/components/latest/js/shieldui-all.min.js"></script>
    <script type="text/javascript" src="http://www.prepbootstrap.com/Content/js/gridData.js"></script>

    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="https://npmcdn.com/simple-statistics@2.0.0-beta3/dist/simple-statistics.min.js"></script>
    <script src="https://d3js.org/queue.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="./d3-tip.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js" type="text/javascript"></script>
      <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js" type="text/javascript"></script>
      <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="Stylesheet" type="text/css" />
   
</head>
<body>
    <div id="wrapper">
          <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">WARRANTY X.0</a>
            </div>
            <div class="collapse navbar-collapse navbar-ex1-collapse">
                <ul id="active" class="nav navbar-nav side-nav">
                    <li class="selected"><a href="index.html"><i class="fa fa-bullseye"></i> Dashboard</a></li>
                    <li><a href="portfolio.html"><i class="fa fa-tasks"></i> Tab 2</a></li>
                    <li><a href="blog.html"><i class="fa fa-globe"></i> Tab 3</a></li>
                    <!-- <li><a href="signup.html"><i class="fa fa-list-ol"></i> SignUp</a></li>
                    <li><a href="register.html"><i class="fa fa-font"></i> Register</a></li>
                    <li><a href="timeline.html"><i class="fa fa-font"></i> Timeline</a></li>
                    <li><a href="forms.html"><i class="fa fa-list-ol"></i> Forms</a></li>
                    <li><a href="typography.html"><i class="fa fa-font"></i> Typography</a></li>
                    <li><a href="bootstrap-elements.html"><i class="fa fa-list-ul"></i> Bootstrap Elements</a></li>
                    <li><a href="bootstrap-grid.html"><i class="fa fa-table"></i> Bootstrap Grid</a></li> -->
                </ul>
                <ul class="nav navbar-nav navbar-right navbar-user">
                    <li class="dropdown user-dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-user"></i> Bhaskar Sharma<b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            <li><a href="#"><i class="fa fa-user"></i> Profile</a></li>
                            <li><a href="#"><i class="fa fa-gear"></i> Settings</a></li>
                            <li class="divider"></li>
                            <li><a href="#"><i class="fa fa-power-off"></i> Log Out</a></li>

                        </ul>
                    </li>
                    <li class="divider-vertical"></li>
                    <li>
                        <form class="navbar-search">
                            <input type="text" placeholder="Search" class="form-control">
                        </form>
                    </li>
                </ul>
            </div>
        </nav>

        <div id="page-wrapper">
            <div class="row">
                <div class="col-lg-12">
                   
                </div>
            </div>
            <div class="row">
             <div class="col-md-3">
                                <div class="panel panel-primary">
                                    <div class="panel-heading">
                                        <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> Data Summary</h3>
                                    </div>
                                    <div class="panel-body">
                                        <div id="records_fetch" ></div>
                                    </div>
                                </div>
            </div>
                <div class="col-md-3">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> Module Distribution</h3>
                        </div>
                        <div class="panel-body">
                            <div id='svgDonut' ></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> DTC STATUS</h3>
                        </div>
                        <div class="panel-body">
                            <div id="svgPie"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> EI Chart</h3>
                            </div>
                            <div class="panel-body">
                                <div ></div>
                            </div>
                        </div>
                    </div>
               
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> Risk Pattern</h3>
                        </div>
                        <div class="panel-body">
                            <div ></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="panel panel-primary">
                        <div class="panel-heading" >
                            <h3 class="panel-title" ><i class="fa fa-bar-chart-o"></i> Top Causal Parts/Country</h3>
                        </div>
                        <div class="panel-body">
                            <div id="svgworldChart"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="panel panel-primary">
                        <div class="panel-heading">
                            <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> Top Causal Parts Failure</h3>
                        </div>
                        <div class="panel-body">
                            <div id="svgBar" ></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                    <div class="col-md-6">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> Causal Part</h3>
                            </div>
                            <div class="panel-body">
                                <div id="CausalTopDTC" ></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> Top 5 DTC</h3>
                            </div>
                            <div class="panel-body">
                                <div id="topDtcgroup" ></div>
                            </div>
                        </div>
                    </div>
                    <!-- <div class="col-md-4">
                        <div class="panel panel-primary">   
                            <div class="panel-heading">
                                <h3 class="panel-title"><i class="fa fa-bar-chart-o"></i> Top Causal Parts Failure</h3>
                            </div>
                            <div class="panel-body">
                                <div ></div>
                            </div>
                        </div>
                    </div> -->
                </div>
            
        </div>
    </div>
    <!-- /#wrapper -->

    <script type="text/javascript">
        const url= 'http://localhost:3000/rows';
    fetch(url)
  .then(function(response) {
    return response.json();
  })
  .then(function(myJson) {
    var elem2 = document.createElement('label');
    elem2.innerHTML = "Total Number of Signals :" +myJson.length; 
    document.getElementById("records_fetch").appendChild(elem2);
  
    CreateCharts(myJson);
});

function CreateCharts(myJson) {
//  console.log(myJson);
d3.selectAll("svg").remove();
   

    
 ///////////////////////////////DOnut CHart///////////////////////////////////////////////////////////
     var div = d3.select("body").append("div").attr("class", "toolTip");
     var $container = $('.chart-container')
    var width = 280,
    height = 200,
    radius = Math.min(width, height) / 2;
    var color = d3.scale.ordinal()
    .range(["#7FFF00", "#FFE4C4", "#FF8C00", "#FFD700", "#CD5C5C"]);

    var legendWidth = 10000;

var arc = d3.svg.arc()
    .outerRadius(radius - 10)
    .innerRadius(radius - 70);

var pie = d3.layout.pie()
    .sort(null)
	 .startAngle(1.1*Math.PI)
    .endAngle(3.1*Math.PI)
    .value(function(d) { return d.values; });

    var JsonByName =[]
    
    JsonByName= d3.nest()
  .key(function(d) { return d.module.substring(0, 3); })
  .rollup(function(v) { return v.length })
  .entries(myJson);

  JsonByName.sort(function(x, y){
   return d3.descending(x.values, y.values);
});

var topData=JsonByName.slice(0, 3)

// console.log(topData);




var svg = d3.select("#svgDonut").append('svg')

  
    .attr("width", '70%')
    .attr("height", '70%')
    .attr('viewBox','0 0 200,200')
    .attr('preserveAspectRatio','xMinYMin')
  .append("g")
    .attr("transform", "translate(" + 103 + "," + 100 + ")");

console.log(Math.min(width,height));
 var g = svg.selectAll(".arc")
      .data(pie(topData))
    .enter().append("g")
      .attr("class", "arc");

  g.append("path")
	.style("fill", function(d) { return color(d.data.key); })
    .transition().delay(function(d,i) {
	return i * 500; }).duration(5000)
	.attrTween('d', function(d) {
		var i = d3.interpolate(d.startAngle+0.1, d.endAngle);
		return function(t) {
			d.endAngle = i(t); 
			return arc(d)
			}
		}); 
  g.append("text")
      .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
      .attr("dy", ".35em")
	  .transition()
	  .delay(1000)
      .text(function(d) { return d.data.values; });
  // define legend
  var legendRectSize = 18;                                  // NEW
        var legendSpacing = 4;    
  var legend = svg.selectAll('.legend')                     // NEW
          .data(color.domain())                                   // NEW
          .enter()                                                // NEW
          .append('g')                                            // NEW
          .attr('class', 'legend')                                // NEW
          .attr('transform', function(d, i) {                     // NEW
            var height = legendRectSize + legendSpacing;          // NEW
            var offset =  height * color.domain().length / 2;     // NEW
            var horz = 2 * legendRectSize;                       // NEW
            var vert = i * height - offset;                       // NEW
            return 'translate(' + width/2 + ',' + vert + ')';        // NEW
          });                                                     // NEW
        legend.append('rect')                                     // NEW
          .attr('width', legendRectSize)                          // NEW
          .attr('height', legendRectSize)                         // NEW
          .style('fill', color)                                   // NEW
          .style('stroke', color);                                // NEW
        legend.append('text')                                     // NEW
          .attr('x', legendRectSize + legendSpacing)              // NEW
          .attr('y', legendRectSize - legendSpacing)
          .style('fill', 'white')              // NEW
          .text(function(d) { return d; }); 
          
	d3.selectAll("path").on("mousemove", function(d) {
	    div.style("left", d3.event.pageX+10+"px");
		  div.style("top", d3.event.pageY-25+"px");
		  div.style("display", "inline-block");
    div.html((d.data.key)+"<br>"+(d.data.values));
});
	  
d3.selectAll("path").on("mouseout", function(d){
    div.style("display", "none");
});
	  
	  
//d3.select("body").transition().style("background-color", "#d3d3d3");
function type(d) {
  d.values = +d.values;
  return d;
}
////////////////////////////////////////////Pie Chart Begins//////////////////////////////

var div_pie = d3.select("body").append("div").attr("class", "toolTip");
    var width_pie = 200,
    height_pie = 150,
    radius_pie = Math.min(width_pie, height_pie) / 2;
    var color_pie = d3.scale.ordinal()
    .range(['#ff4000', '#ffbf00','#bfff00','#ff0080','#8c7373','#660000']);

var arc_pie = d3.svg.arc()
    .outerRadius(radius_pie - 10)
    .innerRadius(0);

var pie_chart = d3.layout.pie()
    .sort(null)
	 .startAngle(1.1*Math.PI)
    .endAngle(3.1*Math.PI)
    .value(function(d) { return d.values; });

    var JsonByNameof_dtc =[]
    
    JsonByNameof_dtc= d3.nest()
  .key(function(d) { return d.dtc_status_conv; })
  .rollup(function(v) { return v.length })
  .entries(myJson);


  JsonByNameof_dtc.sort(function(x, y){
   return d3.descending(x.values, y.values);
});

var topData_pie=JsonByNameof_dtc.slice(0, 5)

// console.log(topData_pie);

//console.log(JsonByNameof_dtc);


var svg_pie = d3.select("#svgPie").append('svg')
.attr("width", '70%')
    .attr("height", '70%')
    .attr('viewBox','-10 -10 290 250')
    .attr('preserveAspectRatio','xMinYMin')
  .append("g")
    .attr("transform", "translate(" + Math.min(width_pie,height_pie)/ 2 + "," + Math.min(width_pie,height_pie)/ 2 + ")");


 var g_pie = svg_pie.selectAll(".arc")
      .data(pie(topData_pie))
    .enter().append("g")
      .attr("class", "arc");

  g_pie.append("path")
	.style("fill", function(d) { return color_pie(d.data.key); })
    .transition().delay(function(d,i) {
	return i * 500; }).duration(5000)
	.attrTween('d', function(d) {
		var i_pie = d3.interpolate(d.startAngle+0.1, d.endAngle);
		return function(t) {
			d.endAngle = i_pie(t); 
			return arc_pie(d)
			}
		}); 
  g_pie.append("text")
      .attr("transform", function(d) { return "translate(" + arc_pie.centroid(d) + ")"; })
      .attr("dy", ".35em")
	  .transition()
	  .delay(1000)
      .text(function(d) { return d.data.values; });

  // var legendRectSize_Pie = 18;                                  // NEW
  //       var legendSpacing_pie = 4;    
  var legend_pie = svg_pie.selectAll('.legend')                     // NEW
          .data(color_pie.domain())                                   // NEW
          .enter()                                                // NEW
          .append('g')                                            // NEW
          .attr('class', 'legend')                                // NEW
          .attr('transform', function(d, i) {                     // NEW
            var height_pieLeg = legendRectSize + legendSpacing;          // NEW
            var offset_pie =  height_pieLeg * color_pie.domain().length / 2;     // NEW
            var horz_pie = 2 * legendRectSize;                       // NEW
            var vert_pie = i * height_pieLeg - offset_pie;                       // NEW
            return 'translate(' + width_pie/2 + ',' + vert_pie + ')';        // NEW
          });                                                     // NEW
        legend_pie.append('rect')                                     // NEW
          .attr('width', legendRectSize)                          // NEW
          .attr('height', legendRectSize)                         // NEW
          .style('fill', color_pie)                                   // NEW
          .style('stroke', color_pie);                                // NEW
        legend_pie.append('text')                                     // NEW
          .attr('x', legendRectSize + legendSpacing)              // NEW
          .attr('y', legendRectSize - legendSpacing)  
          .style('fill', 'white')                // NEW
          .text(function(d) { return d; }); 
          


	d3.selectAll("path").on("mousemove", function(d) {
	    div_pie.style("left", d3.event.pageX+10+"px");
		  div_pie.style("top", d3.event.pageY-25+"px");
		  div_pie.style("display", "inline-block");
    div_pie.html((d.data.key)+"<br>"+(d.data.values));
});
	  
d3.selectAll("path").on("mouseout", function(d){
    div_pie.style("display", "none");
});
	  
	  
//d3.select("body").transition().style("background-color", "#d3d3d3");
function type(d) {
  d.values = +d.values;
  return d;
}

function getTextWidth(text, fontSize, fontName) {
            c = document.createElement("canvas");
            ctx = c.getContext("2d");
            ctx.font = fontSize + ' ' + fontName;
            return ctx.measureText(text).width;
        }

        function DataSegregator(array, on) {
            var SegData;
            OrdinalPositionHolder = {
                valueOf: function () {
                    thisObject = this;
                    keys = Object.keys(thisObject);
                    keys.splice(keys.indexOf("valueOf"), 1);
                    keys.splice(keys.indexOf("keys"), 1);
                    return keys.length == 0 ? -1 : d3.max(keys, function (d) { return thisObject[d] })
                }
                , keys: function () {
                    keys = Object.keys(thisObject);
                    keys.splice(keys.indexOf("valueOf"), 1);
                    keys.splice(keys.indexOf("keys"), 1);
                    return keys;
                }
            }
            array[0].map(function (d) { return d[on] }).forEach(function (b) {
                value = OrdinalPositionHolder.valueOf();
                OrdinalPositionHolder[b] = OrdinalPositionHolder > -1 ? ++value : 0;
            })

            SegData = OrdinalPositionHolder.keys().map(function () {
                return [];
            });

            array.forEach(function (d) {
                d.forEach(function (b) {
                    SegData[OrdinalPositionHolder[b[on]]].push(b);
                })
            });

            return SegData;
        }


        Data = [
{ Date: "2016-06-14", Categories: [{ Name: "Category1", Value: 368 }, { Name: "Category2", Value: 321 }, { Name: "Category3", Value: 524 }], LineCategory: [{ Name: "Line1", Value: 69 }, { Name: "Line2", Value: 63 }] },
{ Date: "2016-06-15", Categories: [{ Name: "Category1", Value: 521 }, { Name: "Category2", Value: 123 }, { Name: "Category3", Value: 653 }], LineCategory: [{ Name: "Line1", Value: 89 }, { Name: "Line2", Value: 96 }] },
{ Date: "2016-06-17", Categories: [{ Name: "Category1", Value: 368 }, { Name: "Category2", Value: 236 }, { Name: "Category3", Value: 537 }], LineCategory: [{ Name: "Line1", Value: 63 }, { Name: "Line2", Value: 35 }] },
{ Date: "2016-06-18", Categories: [{ Name: "Category1", Value: 423 }, { Name: "Category2", Value: 330 }, { Name: "Category3", Value: 689 }], LineCategory: [{ Name: "Line1", Value: 86 }, { Name: "Line2", Value: 45 }] },
{ Date: "2016-06-19", Categories: [{ Name: "Category1", Value: 601 }, { Name: "Category2", Value: 423 }, { Name: "Category3", Value: 490 }], LineCategory: [{ Name: "Line1", Value: 65 }, { Name: "Line2", Value: 63 }] },
{ Date: "2016-06-20", Categories: [{ Name: "Category1", Value: 412 }, { Name: "Category2", Value: 461 }, { Name: "Category3", Value: 321 }], LineCategory: [{ Name: "Line1", Value: 75 }, { Name: "Line2", Value: 85 }] }
        ]

        var margin_bar = { top: 20, right: 30, bottom: 60, left: 40 },
            width_bar = 260 - margin_bar.left - margin_bar.right,
            height_bar = 250 - margin_bar.top - margin_bar.bottom;

        var textWidthHolder = 0;
        /// Adding Date in LineCategory
        Data.forEach(function (d) {
            d.LineCategory.forEach(function (b) {
                b.Date = d.Date;
            })
        });




        var Categories = new Array();
        // Extension method declaration

        Categories.pro

        var Data;
        var ageNames;
        var x0 = d3.scale.ordinal()
            .rangeRoundBands([0, width_bar], .1);
        var XLine_bar = d3.scale.ordinal()
            .rangeRoundPoints([0, width_bar], .1);
        var x1 = d3.scale.ordinal();

        var y_bar = d3.scale.linear()
            .range([height_bar, 0]);

        var YLine_bar = d3.scale.linear().range([height_bar, 0])
        .domain([0, d3.max(Data, function (d) { return d3.max(d.LineCategory, function (b) { return b.Value }) })]);

        var color_bar = d3.scale.ordinal()
            .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

        var line = d3.svg.line().x(function (d) {
            return x0(d.Date) + x0.rangeBand() / 2;
        }).y(function (d) { return YLine_bar(d.Value) });




        var xAxis_bar = d3.svg.axis()
            .scale(x0)
            .orient("bottom");

        var yAxis_bar = d3.svg.axis()
            .scale(y_bar)
            .orient("left")
            .tickFormat(d3.format(".2s"));

        var YLeftAxis = d3.svg.axis().scale(YLine_bar).orient("right").tickFormat(d3.format(".2s"));

        var svg_bar = d3.select("#svgBar").append("svg")
        .attr("width", '70%')
    .attr("height", '70%')
    .attr('viewBox','-10 -10 290 250')
    .attr('preserveAspectRatio','xMinYMin')
          .append("g")
            .attr("transform", "translate(" + margin_bar.left + "," + margin_bar.top + ")");





        // Bar Data categories
        Data.forEach(function (d) {
            d.Categories.forEach(function (b) {
                if (Categories.findIndex(function (c) { return c.Name===b.Name}) == -1) {
                    b.Type = "bar";
                    // console.log(JSON.stringify(b))
                    Categories.push(b)
                }
            })
        });


        // Line Data categories
        Data.forEach(function (d) {
            d.LineCategory.forEach(function (b) {
                if (Categories.findIndex(function (c) { return c.Name === b.Name }) == -1) {
                    b.Type = "line";
                    // console.log(JSON.stringify(b))
                    Categories.push(b)
                }
            })
        });

        // Processing Line data
        lineData = DataSegregator(Data.map(function (d) { return d.LineCategory }), "Name");

        // Line Coloring
        LineColor = d3.scale.ordinal();
        LineColor.domain(Categories.filter(function (d) { return d.Type == "line" }).map(function (d) { return d.Name }));
        LineColor.range(["#d40606", "#06bf00", "#98bdc5", "#671919", "#0b172b"])
        x0.domain(Data.map(function (d) { return d.Date; }));
        XLine_bar.domain(Data.map(function (d) { return d.Date; }));
        x1.domain(Categories.filter(function (d) { return d.Type == "bar" }).map(function (d) { return d.Name})).rangeRoundBands([0, x0.rangeBand()]);
        y_bar.domain([0, d3.max(Data, function (d) { return d3.max(d.Categories, function (d) { return d.Value; }); })]);

        svg_bar.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height_bar + ")")
            .call(xAxis_bar)
            .style('fill','white');

        svg_bar.append("g")
           .attr("class", "y axis")
            .attr("transform", "translate(" + (width_bar) + ",0)")
           .call(YLeftAxis)
           .append("text")
           .attr("transform", "rotate(-90)")
           .attr("y", 10)

           .attr("dy", ".71em")
           .style("text-anchor", "end")
           .text("Percent");

        svg_bar.append("g")
            .attr("class", "y axis")
            .call(yAxis_bar).style('fill','white')
          .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("Failure Probab.");


        var state = svg_bar.selectAll(".state")
            .data(Data)
          .enter().append("g")
            .attr("class", "state")
            .attr("transform", function (d) { return "translate(" + x0(d.Date) + ",0)"; });
           
  
        state.selectAll("rect")
            .data(function (d) { return d.Categories; })
          .enter().append("rect")
            .attr("width", x1.rangeBand())
            .attr("x", function (d) { return x1(d.Name); })
            .attr("y", function (d) { return y_bar(d.Value); })
            //.attr("height", function (d) { return height - y(d.Value); })
            .style("fill", function (d) { return color_bar(d.Name); })
            .transition().delay(5000).ease('linear').attrTween("height", function (d) {
                var i = d3.interpolate(0, height_bar - y_bar(d.Value));
                return function (t)
                {
                    return i(t);
                }
            });

        // drawaing lines
        svg_bar.selectAll(".lines").data(lineData).enter().append("g").attr("class", "line")
        .each(function (d) {
            Name=d[0].Name
            d3.select(this).append("path").attr("d", function (b) { return line(b) }).style({ "stroke-width": "2px", "fill": "none" }).style("stroke", LineColor(Name)).transition().duration(1500);
        })


        // Legends

        var LegendHolder = svg_bar.append("g").attr("class", "legendHolder");
        var legend = LegendHolder.selectAll(".legend")
            .data(Categories.map(function (d) { return {"Name":d.Name,"Type":d.Type}}))
          .enter().append("g")
            .attr("class", "legend")
            .attr("transform", function (d, i) { return "translate(0," +( height_bar+ margin_bar.bottom/2 )+ ")"; })
            .each(function (d,i) {
                //  Legend Symbols


                d3.select(this).append("rect")
                .attr("width", function () { return 18 })
                .attr("x", function (b) {

                    left = (i+1) * 15 + i * 18 + i * 5 + textWidthHolder;
                    return left;
                })
                 .attr("y", function (b) { return b.Type == 'bar'?0:7})
                .attr("height", function (b) { return b.Type== 'bar'? 18:5 })
                .style("fill", function (b) { return b.Type == 'bar' ? color_bar(d.Name) : LineColor(d.Name) });

                //  Legend Text

                d3.select(this).append("text")
                .attr("x", function (b) {

                    left = (i+1) * 15 + (i+1) * 18 + (i + 1) * 5 + textWidthHolder;

                    return left;
                })
                .attr("y", 9)
                .attr("dy", ".35em")
                .style("text-anchor", "start")
                .text(d.Name);

                textWidthHolder += getTextWidth(d.Name, "10px", "calibri");
            });


        // Legend Placing

        d3.select(".legendHolder").attr("transform", function (d) {
            thisWidth = d3.select(this).node().getBBox().width_bar;
            return "translate(" + ((width_bar) / 2 - thisWidth / 2) + ",0)";
        })



/////////////////////////////////////////Bar Failure Prob Chart Ends//////////////////////////////////////////////////////////////////////

////////////////////////////////////////Top 5 Module Causal Parts //////////////////////////////////


var margin_causalPartBar = {top: 20, right: 20, bottom: 30, left: 40},
    width_causalPartBar = 500 - margin_causalPartBar.left - margin_causalPartBar.right,
    height_causalPartBar = 150 - margin_causalPartBar.top - margin_causalPartBar.bottom;

var x0_causalPartBar = d3.scale.ordinal()
    .rangeRoundBands([0, width_causalPartBar], .1);

var x1_causalPartBar = d3.scale.ordinal();

var y_causalPartBar = d3.scale.linear()
    .range([height_causalPartBar, 0]);

var xAxis_causalPartBar = d3.svg.axis()
    .scale(x0_causalPartBar)
    .tickSize(0)
    .orient("bottom");

var yAxis_causalPartBar = d3.svg.axis()
    .scale(y_causalPartBar)
    .orient("left");

var color_causalPartBar = d3.scale.ordinal()
    .range(["#ca0020","#f4a582","#d5d5d5","#92c5de","#0571b0"]);

var svg_causalPartBar = d3.select('#CausalTopDTC').append("svg")
    .attr("width", width_causalPartBar + margin_causalPartBar.left + margin_causalPartBar.right)
    .attr("height", height_causalPartBar + margin_causalPartBar.top + margin_causalPartBar.bottom)
  .append("g")
    .attr("transform", "translate(" + margin_causalPartBar.left + "," + margin_causalPartBar.top + ")");


// Get the data

 
   var JsonCauslaPart_grouping = d3.nest()
  .key(function(d) { return d.module.substring(0, 3); })
  .key(function(d) { return d.predict; })
  .rollup(function(v) { return v.length })
  .entries(myJson);
//   JsonCauslaPart_grouping.sort(function(x, y){
//    return  d3.descending(x.values, y.values);});

var requiredData =[];

for (let index = 0; index < JsonCauslaPart_grouping.length; index++) {
    var sortedArray = JsonCauslaPart_grouping[index].values.sort(function(a, b) {
        return d3.descending( a.values , b.values);
    }).slice(0,5);
//    var topData_causalPartBar = (sortedArray.slice(0,5));
//     console.log(requiredData.push(topData_causalPartBar))
}
var topData_causalPartBar = JsonCauslaPart_grouping;

console.log(topData_causalPartBar);

   var categoriesNames = topData_causalPartBar.map(function(d) { return d.key; });
  var rateNames = topData_causalPartBar[0].values.map(function(d) { return d.key; });

  x0_causalPartBar.domain(categoriesNames);
  x1_causalPartBar.domain(rateNames).rangeRoundBands([0, x0_causalPartBar.rangeBand()]);
  y_causalPartBar.domain([0, d3.max(topData_causalPartBar, function(categorie) { return d3.max(categorie.values, function(d) { return d.values; }); })]);

  svg_causalPartBar.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height_causalPartBar + ")")
      .call(xAxis_causalPartBar)
      .style('fill', 'white') ;
  svg_causalPartBar.append("g")
      .attr("class", "y axis")
      .style('opacity','0')
      .call(yAxis_causalPartBar)
  .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style('fill', 'white') 
      .style("text-anchor", "end")
      .style('font-weight','bold')
      .text("Value");

  svg_causalPartBar.select('.y').transition().duration(500).delay(1300).style('opacity','1');

  var slice_causalPartBar = svg_causalPartBar.selectAll(".slice")
      .data(topData_causalPartBar)
      .enter().append("g")
      .attr("class", "g")
      .attr("transform",function(d) { return "translate(" + x0_causalPartBar(d.key) + ",0)"; });

  slice_causalPartBar.selectAll("rect")
      .data(function(d) { return d.values; })
  .enter().append("rect")
      .attr("width", x1_causalPartBar.rangeBand())
      .attr("x", function(d) { return x1_causalPartBar(d.key); })
      .style("fill", function(d) { return color_causalPartBar(d.key) })
      .attr("y", function(d) { return y_causalPartBar(0); })
      .attr("height", function(d) { return height_causalPartBar - y_causalPartBar(0); })
      .on("mouseover", function(d) {
          d3.select(this).style("fill", d3.rgb(color_causalPartBar(d.key)).darker(2));
      })
      .on("mouseout", function(d) {
          d3.select(this).style("fill", color_causalPartBar(d.key));
      });

  slice_causalPartBar.selectAll("rect")
      .transition()
      .delay(function (d) {return Math.random()*1000;})
      .duration(1000)
      .attr("y", function(d) { return y_causalPartBar(d.values); })
      .attr("height", function(d) { return height_causalPartBar - y_causalPartBar(d.values); });

  //Legend
  // var legend_causalPartBar = svg_causalPartBar.selectAll(".legend")
  //     .data(topData_causalPartBar[0].values.map(function(d) { return d.key; }).reverse())
  // .enter().append("g")
  //     .attr("class", "legend")
  //     .attr("transform", function(d,i) { return "translate(0," + i * 30 + ")"; })
  //   // .attr("transform", function(d, i) { return "translate(" + (-700+i*100) + "," + 0 + ")"; })
  //   //.attr('transform', function(d, i) { return "translate(" + -40*i + "," + 0 + ")"; })
  //   .attr("width", 36) 
  //   .style("opacity","0");

  // legend_causalPartBar.append("rect")
  //     .attr("x", width - 10)
  //     .attr("width", 18)
  //     .attr("height", 18)
  //     .style("fill", function(d) { return color_causalPartBar(d); });

  // legend_causalPartBar.append("text")
  //     .attr("x", width - 10)
  //     .attr("y", 9)
  //     .attr("dy", ".35em")
  //     .style("text-anchor", "end")
  //     .text(function(d) {return d; });

  // legend_causalPartBar.transition().duration(500).delay(function(d,i){ return 1300 + 100 * i; }).style("opacity","1");
  
////////////////////////////TOP 5 DTC /////////////////////////////////////////////////////////////

var margin_DTCfaultGrouping = {top: 20, right: 20, bottom: 30, left: 40},
    width_DTCfaultGrouping = 500 - margin_DTCfaultGrouping.left - margin_DTCfaultGrouping.right,
    height_DTCfaultGrouping = 150 - margin_DTCfaultGrouping.top - margin_DTCfaultGrouping.bottom;

var x0_DTCfaultGrouping = d3.scale.ordinal()
    .rangeRoundBands([0, width_DTCfaultGrouping], .1);

var x1_DTCfaultGrouping = d3.scale.ordinal();

var y_DTCfaultGrouping = d3.scale.linear()
    .range([height_DTCfaultGrouping, 0]);

var xAxis_DTCfaultGrouping = d3.svg.axis()
    .scale(x0_DTCfaultGrouping)
    .tickSize(0)
    .orient("bottom");

var yAxis_DTCfaultGrouping = d3.svg.axis()
    .scale(y_DTCfaultGrouping)
    .orient("left");

var color_DTCfaultGrouping = d3.scale.ordinal()
    .range(["#ca0020","#f4a582","#d5d5d5","#92c5de","#0571b0"]);

var svg_DTCfaultGrouping = d3.select('#topDtcgroup').append("svg")
    .attr("width", width_DTCfaultGrouping + margin_DTCfaultGrouping.left + margin_DTCfaultGrouping.right)
    .attr("height", height_DTCfaultGrouping + margin_DTCfaultGrouping.top + margin_DTCfaultGrouping.bottom)
  .append("g")
    .attr("transform", "translate(" + margin_DTCfaultGrouping.left + "," + margin_DTCfaultGrouping.top + ")");


// Get the data
  //d3.json("new.json", function(error, data) {
   //////////Grouping Bar Chart /////////////////////////////////////////////

   var Json_DTCfaultGrouping = d3.nest()
  .key(function(d) { return d.base_dtc; })
  .key(function(d) { return d.fault_type_description; })
  .rollup(function(v) { return v.length })
  .entries(myJson);
  Json_DTCfaultGrouping.sort(function(x, y){
   return d3.descending(x.values, y.values);
});

var topData_DTCfaultGrouping=Json_DTCfaultGrouping.slice(0, 5)

// console.log(topData_DTCfaultGrouping);

   var categoriesNames_DTCfaultGrouping = topData_DTCfaultGrouping.map(function(d) { return d.key; });
  var rateNames_DTCfaultGrouping = topData_DTCfaultGrouping[0].values.map(function(d) { return d.key; });

  x0_DTCfaultGrouping.domain(categoriesNames_DTCfaultGrouping);
  x1_DTCfaultGrouping.domain(rateNames_DTCfaultGrouping).rangeRoundBands([0, x0_DTCfaultGrouping.rangeBand()]);
  y_DTCfaultGrouping.domain([0, d3.max(topData_DTCfaultGrouping, function(categorie_DTCfaultGrouping) { return d3.max(categorie_DTCfaultGrouping.values, function(d) { return d.values; }); })]);

  svg_DTCfaultGrouping.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height_DTCfaultGrouping + ")")
      .call(xAxis_DTCfaultGrouping)
      .style('fill', 'white');

  svg_DTCfaultGrouping.append("g")
      .attr("class", "y axis")
      .style('opacity','0')
      .call(yAxis_DTCfaultGrouping)
  .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style('fill', 'white')   
      .style("text-anchor", "end")
      .style('font-weight','bold')
      .text("Value");

  svg_DTCfaultGrouping.select('.y').transition().duration(500).delay(1300).style('opacity','1');

  var slice_DTCfaultGrouping = svg_DTCfaultGrouping.selectAll(".slice")
      .data(topData_DTCfaultGrouping)
      .enter().append("g")
      .attr("class", "g")
      .attr("transform",function(d) { return "translate(" + x0_DTCfaultGrouping(d.key) + ",0)"; });

  slice_DTCfaultGrouping.selectAll("rect")
      .data(function(d) { return d.values; })
  .enter().append("rect")
      .attr("width", x1_DTCfaultGrouping.rangeBand())
      .attr("x", function(d) { return x1_DTCfaultGrouping(d.key); })
      .style("fill", function(d) { return color_DTCfaultGrouping(d.key) })
      .attr("y", function(d) { return y_DTCfaultGrouping(0); })
      .attr("height", function(d) { return height_DTCfaultGrouping - y_DTCfaultGrouping(0); })
      .on("mouseover", function(d) {
          d3.select(this).style("fill", d3.rgb(color_DTCfaultGrouping(d.key)).darker(2));
      })
      .on("mouseout", function(d) {
          d3.select(this).style("fill", color_DTCfaultGrouping(d.key));
      });

  slice_DTCfaultGrouping.selectAll("rect")
      .transition()
      .delay(function (d) {return Math.random()*1000;})
      .duration(1000)
      .attr("y", function(d) { return y_DTCfaultGrouping(d.values); })
      .attr("height", function(d) { return height_DTCfaultGrouping - y_DTCfaultGrouping(d.values); });

  //Legend
  // var legend = svg.selectAll(".legend")
  //     .data(topData_causalPartBar[0].values.map(function(d) { return d.key; }).reverse())
  // .enter().append("g")
  //     .attr("class", "legend")
  //     .attr("transform", function(d,i) { return "translate(0," + i * 30 + ")"; })
  //   // .attr("transform", function(d, i) { return "translate(" + (-700+i*100) + "," + 0 + ")"; })
  //   //.attr('transform', function(d, i) { return "translate(" + -40*i + "," + 0 + ")"; })
  //   .attr("width", 36) 
  //   .style("opacity","0");

  // legend.append("rect")
  //     .attr("x", width - 10)
  //     .attr("width", 18)
  //     .attr("height", 18)
  //     .style("fill", function(d) { return color(d); });

  // legend.append("text")
  //     .attr("x", width - 10)
  //     .attr("y", 9)
  //     .attr("dy", ".35em")
  //     .style("text-anchor", "end")
  //     .text(function(d) {return d; });

  // legend.transition().duration(500).delay(function(d,i){ return 1300 + 100 * i; }).style("opacity","1");

///////////////WORLD MAP CHART///////////////////////////////////////////////////////////////////////



var format = d3.format(",");


// Set tooltips
var tip_worldMap = d3.tip()
            .attr('class', 'd3-tip')
            .offset([70, 0])
            .html(function(d) {
              return "<strong>Country: </strong><span class='details'>" + d.properties.name + "<br></span>" + "<strong>total Count: </strong><span class='details'>" + format(d.population) +"</span>";
            })

var margin_worldMap = {top: 0, right: 0, bottom: 0, left: 0},
            width_WorldMap =300 - margin_worldMap.left - margin_worldMap.right,
            height_worldMap = 250 - margin_worldMap.top - margin_worldMap.bottom;

var color_worldMap = d3.scale.threshold()
.domain([0,1,10,100,500,1000,5000,10000,500000000,1500000000])
    .range(["rgb(247,251,255)", "rgb(222,235,247)", "rgb(198,219,239)", "rgb(158,202,225)", "rgb(107,174,214)", "rgb(66,146,198)","rgb(33,113,181)","rgb(8,81,156)","rgb(8,48,107)","rgb(3,19,43)"]);

var path_worldMap = d3.geo.path();

var svg_WorldMap = d3.select("#svgworldChart").append('svg')
           // .append("svg")
           .attr("width", '80%')
    .attr("height", '80%')
    .attr('viewBox','-10 -10 290 250')
    .attr('preserveAspectRatio','xMinYMin')
            .append('g')
            .attr('class', 'map');

var projection = d3.geo.mercator()
                   .scale(100)
                  .translate( [width_WorldMap / 2, height_worldMap / 1.5]);

var path_worldMAp_new = d3.geo.path().projection(projection);

svg_WorldMap.call(tip_worldMap);

queue()
   .defer(d3.json, "readme-world-110m.json")
   .defer(d3.tsv, "world_population.tsv")
  .await(ready);

 function ready(error, data, total) {

  var JsonByNameof_Country = [];
 
JsonByNameof_Country= d3.nest()
  .key(function(d) { return d.country;})
  .rollup(function(v) { return v.length })
  .entries(myJson);

// console.log(JsonByNameof_Country);

var populationById = {};

total.forEach(function(d) {populationById[d.id] = +d.population; });
data.features.forEach(function(d) {d.population = populationById[d.id] });

  svg_WorldMap.append("g")
      .attr("class", "countries")
    .selectAll("path")
      .data(data.features)
    .enter().append("path")
      .attr("d", path_worldMAp_new)
      .style("fill", function(d) { return color_worldMap(populationById[d.id]); })
      .style('stroke', 'blue')
      .style('stroke-width', 1.5)
      .style("opacity",0.8)
      
      // tooltips
        .style("stroke","blue")
        .style('stroke-width', 0.3)
        .on('mouseover',function(d){
          tip_worldMap.show(d,this);

          d3.select(this)
            .style("opacity", 1)
            .style("stroke","blue")
            .style("stroke-width",3);
        })
        .on('mouseout', function(d){
          tip_worldMap.hide(d,this);

          d3.select(this)
            .style("opacity", 0.8)
            .style("stroke","blue")
            .style("stroke-width",0.3);
        });
        var label = svg_WorldMap.selectAll("text")
    .data(data.features)
    .enter()
    .append("text")
      .attr("class", "label")
      .attr("transform", function(d) { return "translate(" + path_worldMAp_new.centroid(d) + ")"; });
     // .text(function(d) { return d.population +  d.id;} );

        svg_WorldMap.append("path")
      .datum(topojson.mesh(data.features, function(a, b) { return a.id !== b.id; }))
       // .datum(topojson.mesh(data.features, function(a, b) { return a !== b; }))
      .attr("class", "names")
      .attr("d", path_worldMAp_new);

console.log("map completed")

}   
}

    </script>
</body>
</html>
